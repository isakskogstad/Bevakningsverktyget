<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget & K√∂phistorik | Bevakningsverktyget</title>
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/main.css">
    <style>
        .tool-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tool-header {
            margin-bottom: 2rem;
        }

        .tool-header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .tool-header p {
            color: var(--text-secondary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .stat-card.warning {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }

        .stat-card.danger {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-value.success { color: #10b981; }
        .stat-value.warning { color: #f59e0b; }
        .stat-value.danger { color: #ef4444; }

        .stat-sub {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-fill.warning { background: #f59e0b; }
        .progress-fill.danger { background: #ef4444; }

        /* Sections */
        .section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Settings form */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-top: 1.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* History table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            background: var(--bg-secondary);
        }

        .history-table td {
            color: var(--text-primary);
        }

        .history-table tr:hover td {
            background: var(--bg-secondary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Month breakdown */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .month-item {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .month-item-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .month-item-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .month-item-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .history-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar - inkluderas via JS eller kopieras -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="../../" class="sidebar-logo">Bevakningsverktyget</a>
            </div>
            <nav class="sidebar-nav">
                <a href="../../" class="sidebar-link">
                    <span class="icon">üè†</span> Dashboard
                </a>
                <div class="sidebar-section-title">Verktyg</div>
                <a href="../../verktyg/foretagsbevakning/" class="sidebar-link">
                    <span class="icon">üîî</span> F√∂retagsbevakning
                </a>
                <a href="../../verktyg/allabolag/" class="sidebar-link">
                    <span class="icon">üîç</span> Allabolag
                </a>
                <a href="../../verktyg/bolagsverket-api/" class="sidebar-link">
                    <span class="icon">üèõÔ∏è</span> Bolagsverket API
                </a>
                <a href="../../verktyg/xbrl-parser/" class="sidebar-link">
                    <span class="icon">üìä</span> XBRL-parser
                </a>
                <a href="../../verktyg/artikelgenerator/" class="sidebar-link">
                    <span class="icon">‚úçÔ∏è</span> Artikelgenerator
                </a>
                <a href="../../verktyg/pdf-parser/" class="sidebar-link">
                    <span class="icon">üìÑ</span> PDF-parser
                </a>
                <a href="../../verktyg/pressbilder/" class="sidebar-link">
                    <span class="icon">üì∏</span> Pressbilder
                </a>
                <div class="sidebar-section-title">Admin</div>
                <a href="./" class="sidebar-link active">
                    <span class="icon">üí∞</span> Budget & K√∂p
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="tool-container">
                <div class="tool-header">
                    <h1>üí∞ Budget & K√∂phistorik</h1>
                    <p>Hantera budget f√∂r dokumentk√∂p och se din k√∂phistorik</p>
                </div>

                <!-- Stats -->
                <div id="stats-container">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">‚öôÔ∏è Budgetinst√§llningar</h2>
                        <button class="btn btn-primary" id="save-settings-btn" onclick="saveSettings()">
                            Spara √§ndringar
                        </button>
                    </div>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="monthly-limit">M√•nadsgr√§ns (SEK)</label>
                            <input type="number" id="monthly-limit" value="500" min="0" step="50">
                        </div>
                        <div class="form-group">
                            <label for="daily-limit">Daglig gr√§ns (SEK)</label>
                            <input type="number" id="daily-limit" value="100" min="0" step="10">
                        </div>
                        <div class="form-group">
                            <label for="alert-threshold">Varningsgr√§ns (%)</label>
                            <input type="number" id="alert-threshold" value="80" min="0" max="100" step="5">
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="auto-stop" checked>
                            <label for="auto-stop">Stoppa k√∂p automatiskt vid gr√§ns</label>
                        </div>
                    </div>
                </div>

                <!-- Purchase History -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üìã K√∂phistorik</h2>
                        <button class="btn btn-secondary" onclick="loadHistory()">
                            üîÑ Uppdatera
                        </button>
                    </div>
                    <div id="history-container">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Breakdown -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üìä M√•nads√∂versikt</h2>
                    </div>
                    <div id="monthly-breakdown">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://wzkohritxdrstsmwopco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6a29ocml0eGRyc3RzbXdvcGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMjkzMjUsImV4cCI6MjA4MDgwNTMyNX0.GigaAVp781QF9rv-AslVD_p4ksT8auWHwXU72H1kOqo';
        const BUDGET_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/budget`;

        let currentStats = null;

        async function fetchBudget(endpoint = '', options = {}) {
            const url = endpoint ? `${BUDGET_FUNCTION_URL}/${endpoint}` : BUDGET_FUNCTION_URL;

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            return response.json();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('sv-SE', {
                style: 'currency',
                currency: 'SEK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('sv-SE', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getProgressClass(percent) {
            if (percent >= 90) return 'danger';
            if (percent >= 70) return 'warning';
            return '';
        }

        function getStatClass(percent) {
            if (percent >= 90) return 'danger';
            if (percent >= 70) return 'warning';
            return 'success';
        }

        async function loadStats() {
            const container = document.getElementById('stats-container');

            try {
                const data = await fetchBudget();

                if (!data.success) {
                    throw new Error(data.error || 'Kunde inte h√§mta budgetdata');
                }

                currentStats = data;

                // Update settings form
                document.getElementById('monthly-limit').value = data.settings.monthly_limit_sek;
                document.getElementById('daily-limit').value = data.settings.daily_limit_sek;
                document.getElementById('alert-threshold').value = Math.round(data.settings.alert_threshold * 100);
                document.getElementById('auto-stop').checked = data.settings.auto_stop;

                const monthlyClass = getProgressClass(data.monthlyPercentUsed);
                const dailyClass = getProgressClass(data.dailyPercentUsed);

                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card ${monthlyClass ? monthlyClass : ''}">
                            <div class="stat-label">M√•nadsbudget (${data.currentMonth})</div>
                            <div class="stat-value ${getStatClass(data.monthlyPercentUsed)}">
                                ${formatCurrency(data.currentMonthSpending)}
                            </div>
                            <div class="stat-sub">
                                av ${formatCurrency(data.settings.monthly_limit_sek)}
                                (${formatCurrency(data.currentMonthRemaining)} kvar)
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill ${monthlyClass}" style="width: ${Math.min(data.monthlyPercentUsed, 100)}%"></div>
                            </div>
                        </div>

                        <div class="stat-card ${dailyClass ? dailyClass : ''}">
                            <div class="stat-label">Dagens utgifter</div>
                            <div class="stat-value ${getStatClass(data.dailyPercentUsed)}">
                                ${formatCurrency(data.todaySpending)}
                            </div>
                            <div class="stat-sub">
                                av ${formatCurrency(data.settings.daily_limit_sek)}
                                (${formatCurrency(data.todayRemaining)} kvar)
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill ${dailyClass}" style="width: ${Math.min(data.dailyPercentUsed, 100)}%"></div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Totalt antal k√∂p</div>
                            <div class="stat-value">${data.totalPurchases}</div>
                            <div class="stat-sub">
                                Totalt: ${formatCurrency(data.totalSpent)}
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Status</div>
                            <div class="stat-value ${data.settings.auto_stop ? 'success' : 'warning'}">
                                ${data.settings.auto_stop ? 'üõ°Ô∏è Skyddad' : '‚ö†Ô∏è Obegr√§nsad'}
                            </div>
                            <div class="stat-sub">
                                Auto-stopp ${data.settings.auto_stop ? 'aktiverat' : 'inaktiverat'}
                            </div>
                        </div>
                    </div>
                `;

                // Update monthly breakdown
                renderMonthlyBreakdown(data.byMonth);

            } catch (error) {
                console.error('Error loading stats:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Kunde inte h√§mta budgetdata</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadStats()" style="margin-top: 1rem;">
                            F√∂rs√∂k igen
                        </button>
                    </div>
                `;
            }
        }

        function renderMonthlyBreakdown(byMonth) {
            const container = document.getElementById('monthly-breakdown');

            if (!byMonth || Object.keys(byMonth).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Ingen k√∂phistorik √§nnu</p>
                    </div>
                `;
                return;
            }

            // Sort months descending
            const months = Object.entries(byMonth).sort((a, b) => b[0].localeCompare(a[0]));

            container.innerHTML = `
                <div class="month-grid">
                    ${months.map(([month, data]) => `
                        <div class="month-item">
                            <div class="month-item-label">${month}</div>
                            <div class="month-item-value">${formatCurrency(data.total)}</div>
                            <div class="month-item-count">${data.count} k√∂p</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function loadHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const data = await fetchBudget('history?limit=50');

                if (!data.success) {
                    throw new Error(data.error || 'Kunde inte h√§mta historik');
                }

                if (!data.purchases || data.purchases.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Inga k√∂p registrerade √§nnu</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Org.nr</th>
                                <th>F√∂retag</th>
                                <th>Dokumenttyp</th>
                                <th>Belopp</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.purchases.map(p => `
                                <tr>
                                    <td>${formatDate(p.created_at)}</td>
                                    <td><code>${p.orgnr}</code></td>
                                    <td>${p.company_name || '-'}</td>
                                    <td>${p.document_type || '-'}</td>
                                    <td><strong>${formatCurrency(p.amount_sek)}</strong></td>
                                    <td>
                                        <span class="status-badge status-${p.status}">
                                            ${p.status === 'completed' ? '‚úì Genomf√∂rt' :
                                              p.status === 'pending' ? '‚è≥ V√§ntar' :
                                              p.status === 'failed' ? '‚úó Misslyckades' : p.status}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error('Error loading history:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Kunde inte h√§mta k√∂phistorik</p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function saveSettings() {
            const btn = document.getElementById('save-settings-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sparar...';

            try {
                const updates = {
                    monthly_limit_sek: parseFloat(document.getElementById('monthly-limit').value),
                    daily_limit_sek: parseFloat(document.getElementById('daily-limit').value),
                    alert_threshold: parseFloat(document.getElementById('alert-threshold').value) / 100,
                    auto_stop: document.getElementById('auto-stop').checked
                };

                const data = await fetchBudget('settings', {
                    method: 'PUT',
                    body: JSON.stringify(updates)
                });

                if (!data.success) {
                    throw new Error(data.error || 'Kunde inte spara inst√§llningar');
                }

                btn.textContent = '‚úì Sparat!';
                btn.style.background = '#10b981';

                // Reload stats to reflect changes
                await loadStats();

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error saving settings:', error);
                btn.textContent = '‚úó Fel';
                btn.style.background = '#ef4444';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 2000);

                alert('Kunde inte spara inst√§llningar: ' + error.message);
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadHistory();
        });
    </script>
</body>
</html>
