<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS-l√§sare - Bevakningsverktyget</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/reset.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/layout.css">
    <link rel="stylesheet" href="../../assets/css/utilities.css">
    <style>
        /* RSS-specifika stilar */
        body { background: var(--gray-100); }

        .rss-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: var(--spacing-6);
            height: calc(100vh - var(--nav-height));
        }

        @media (max-width: 900px) {
            .rss-grid { grid-template-columns: 1fr; }
            .feeds-sidebar { display: none; }
        }

        /* Feeds sidebar */
        .feeds-sidebar {
            background: var(--white);
            border-right: 1px solid var(--gray-300);
            padding: var(--spacing-4);
            overflow-y: auto;
        }

        .feed-category-title {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: var(--spacing-3) var(--spacing-2);
            margin-top: var(--spacing-4);
        }

        .feed-category-title:first-child { margin-top: 0; }

        .feed-source {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .feed-source:hover { background: var(--gray-100); }
        .feed-source.active { background: var(--accent-muted); }

        .feed-source-icon {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-sm);
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .feed-source-name {
            flex: 1;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .feed-source-count {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: var(--radius-full);
        }

        /* Articles container */
        .articles-container {
            padding: var(--spacing-4);
            overflow-y: auto;
        }

        .articles-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-4);
        }

        .articles-header h2 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
        }

        /* Articles grid - f√∂rb√§ttrad layout */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: var(--spacing-4);
        }

        @media (max-width: 600px) {
            .articles-grid {
                grid-template-columns: 1fr;
            }
        }

        /* F√∂rb√§ttrade artikelkort med bilder */
        .article-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-300);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            flex-direction: column;
        }

        .article-card:hover {
            border-color: var(--dark);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .article-card.read { opacity: 0.7; }

        .article-card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: var(--gray-200);
        }

        .article-card-image-placeholder {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, var(--gray-200) 0%, var(--gray-300) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            opacity: 0.5;
        }

        .article-card-content {
            padding: var(--spacing-4);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .article-source {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            margin-bottom: var(--spacing-2);
            flex-wrap: wrap;
        }

        .article-source-badge {
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-weight: var(--font-weight-medium);
        }

        .article-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-snug);
            margin-bottom: var(--spacing-2);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-excerpt {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            line-height: var(--line-height-normal);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }

        .article-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-top: var(--spacing-3);
            padding-top: var(--spacing-3);
            border-top: 1px solid var(--gray-200);
            font-size: var(--font-size-xs);
            color: var(--gray-500);
        }

        .article-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-left: auto;
        }

        .article-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: background var(--transition-fast);
        }

        .article-action-btn:hover {
            background: var(--gray-100);
        }

        /* Keyword alerts */
        .keyword-match {
            background: var(--accent-muted);
            padding: 0 4px;
            border-radius: 2px;
            font-size: var(--font-size-xs);
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: var(--spacing-4);
        }

        .search-box input {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            padding-left: 40px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        /* Filters */
        .filter-tabs {
            display: flex;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            background: var(--white);
            border: 1px solid var(--gray-300);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .filter-tab:hover { border-color: var(--dark); }
        .filter-tab.active { background: var(--dark); color: var(--white); border-color: var(--dark); }

        /* ============================================
           LIGHTBOX - Artikelvisning
           ============================================ */
        .article-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-4);
            backdrop-filter: blur(4px);
        }

        .article-lightbox.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .lightbox-container {
            background: var(--white);
            border-radius: var(--radius-xl);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .lightbox-header {
            padding: var(--spacing-4) var(--spacing-6);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gray-50);
        }

        .lightbox-source {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .lightbox-source-badge {
            background: var(--dark);
            color: var(--white);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .lightbox-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        .lightbox-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: var(--radius-md);
            transition: background var(--transition-fast);
        }

        .lightbox-close:hover {
            background: var(--gray-200);
        }

        .lightbox-content {
            padding: var(--spacing-6);
            overflow-y: auto;
            flex: 1;
        }

        .lightbox-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-6);
        }

        .lightbox-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            line-height: var(--line-height-snug);
            margin-bottom: var(--spacing-4);
        }

        .lightbox-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-bottom: var(--spacing-6);
            padding-bottom: var(--spacing-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .lightbox-text {
            font-size: var(--font-size-base);
            line-height: var(--line-height-relaxed);
            color: var(--gray-700);
        }

        .lightbox-text p {
            margin-bottom: var(--spacing-4);
        }

        .lightbox-full-content {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            margin-top: var(--spacing-6);
        }

        .lightbox-full-content h4 {
            margin-bottom: var(--spacing-4);
            color: var(--gray-600);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .lightbox-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-8);
            color: var(--gray-500);
        }

        .lightbox-footer {
            padding: var(--spacing-4) var(--spacing-6);
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
            display: flex;
            gap: var(--spacing-3);
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="dashboard-nav">
        <div class="nav-inner">
            <div class="d-flex items-center gap-4">
                <a href="../../" class="nav-brand">Bevakningsverktyget</a>
                <span class="text-muted">‚Ä∫</span>
                <span class="font-medium">RSS-l√§sare</span>
            </div>
            <div class="nav-right">
                <button class="btn btn-secondary btn-sm" onclick="refreshAllFeeds()">
                    <span id="refresh-icon">üîÑ</span> Uppdatera
                </button>
                <button class="btn btn-secondary btn-sm" onclick="toggleSettings()">‚öôÔ∏è</button>
                <a href="../../" class="btn btn-ghost btn-sm">‚Üê Tillbaka</a>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <div class="rss-grid">
        <!-- Feeds sidebar -->
        <aside class="feeds-sidebar">
            <div class="search-box">
                <input type="text" id="feed-search" placeholder="S√∂k k√§llor...">
            </div>

            <div id="feeds-list">
                <div class="empty-state p-4">
                    <div class="loader"></div>
                    <p class="mt-2 text-sm">Laddar k√§llor...</p>
                </div>
            </div>
        </aside>

        <!-- Articles list -->
        <main class="articles-container">
            <div class="articles-header">
                <h2 id="articles-title">Alla nyheter</h2>
                <div class="d-flex gap-2">
                    <select id="sort-select" class="btn btn-secondary btn-sm">
                        <option value="newest">Nyast f√∂rst</option>
                        <option value="oldest">√Ñldst f√∂rst</option>
                    </select>
                </div>
            </div>

            <div class="filter-tabs" id="category-tabs">
                <button class="filter-tab active" data-category="all">Alla</button>
                <button class="filter-tab" data-category="tech">Tech</button>
                <button class="filter-tab" data-category="finans">Finans</button>
                <button class="filter-tab" data-category="nyheter">Nyheter</button>
            </div>

            <div id="articles-list">
                <div class="empty-state">
                    <div class="loader loader-lg"></div>
                    <p class="mt-4">H√§mtar nyheter...</p>
                </div>
            </div>
        </main>

    </div>

    <!-- Article Lightbox -->
    <div class="article-lightbox" id="article-lightbox" onclick="closeLightboxOnBackdrop(event)">
        <div class="lightbox-container" onclick="event.stopPropagation()">
            <div class="lightbox-header">
                <div class="lightbox-source">
                    <span class="lightbox-source-badge" id="lightbox-source"></span>
                    <span class="text-muted" id="lightbox-date"></span>
                </div>
                <div class="lightbox-actions">
                    <button class="btn btn-secondary btn-sm" onclick="bookmarkArticle()" title="Spara">‚≠ê</button>
                    <button class="btn btn-secondary btn-sm" onclick="shareArticle()" title="Dela">üì§</button>
                    <button class="lightbox-close" onclick="closeLightbox()" title="St√§ng">√ó</button>
                </div>
            </div>
            <div class="lightbox-content" id="lightbox-content">
                <!-- Fylls i dynamiskt -->
            </div>
            <div class="lightbox-footer">
                <button class="btn btn-secondary" onclick="investigateArticle()">
                    üîç Unders√∂k vidare
                </button>
                <a href="#" id="lightbox-link" target="_blank" class="btn btn-accent">
                    L√§s p√• originalk√§llan ‚Üí
                </a>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Inst√§llningar</h3>
                <button class="modal-close" onclick="toggleSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <h4 class="font-semibold mb-4">Bevakade nyckelord</h4>
                <p class="text-sm text-muted mb-4">Artiklar som inneh√•ller dessa ord markeras</p>
                <div id="keywords-list" class="mb-4"></div>
                <div class="d-flex gap-2">
                    <input type="text" id="new-keyword" placeholder="L√§gg till nyckelord..." class="flex-1">
                    <button class="btn btn-accent btn-sm" onclick="addKeyword()">L√§gg till</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/api.js"></script>
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/components.js"></script>
    <script>
        // =========================================================================
        // RSS READER - Klientkod
        // =========================================================================

        // RSS feeds konfiguration
        const RSS_FEEDS = [
            // Svenska Tech/Business
            { id: 'breakit', name: 'Breakit', url: 'https://www.breakit.se/feed/artiklar', category: 'tech', enabled: true },
            { id: 'realtid', name: 'Realtid', url: 'https://www.realtid.se/rss/senaste', category: 'finans', enabled: true },
            { id: 'nyteknik', name: 'Ny Teknik', url: 'https://www.nyteknik.se/feed', category: 'tech', enabled: true },
            { id: 'di', name: 'Di Digital', url: 'https://digital.di.se/rss', category: 'finans', enabled: true },

            // Svenska Dagstidningar
            { id: 'svt', name: 'SVT Nyheter', url: 'https://www.svt.se/nyheter/rss.xml', category: 'nyheter', enabled: true },
            { id: 'omni', name: 'Omni', url: 'https://omni.se/rss', category: 'nyheter', enabled: true },

            // Internationella Tech
            { id: 'techcrunch', name: 'TechCrunch', url: 'https://techcrunch.com/feed/', category: 'tech', enabled: true },
            { id: 'theverge', name: 'The Verge', url: 'https://www.theverge.com/rss/index.xml', category: 'tech', enabled: true },
            { id: 'hackernews', name: 'Hacker News', url: 'https://hnrss.org/frontpage', category: 'tech', enabled: true },

            // Internationella Finans
            { id: 'reuters', name: 'Reuters', url: 'https://www.reutersagency.com/feed/', category: 'finans', enabled: true }
        ];

        // State
        let articles = [];
        let selectedArticle = null;
        let currentCategory = 'all';
        let currentFeed = null;
        let keywords = Utils.getStorage('rss-keywords', ['startup', 'greentech', 'cleantech', 'klimat']);
        let readArticles = Utils.getStorage('rss-read', []);

        // RSS proxy URL - anv√§nder rss2json API som konverterar och proxar RSS
        const RSS2JSON_API = 'https://api.rss2json.com/v1/api.json?rss_url=';

        // =========================================================================
        // FETCH RSS
        // =========================================================================

        async function fetchFeed(feed) {
            try {
                // Anv√§nd rss2json API som returnerar JSON direkt
                const apiUrl = RSS2JSON_API + encodeURIComponent(feed.url);
                const response = await fetch(apiUrl);

                if (!response.ok) throw new Error('Fetch failed');

                const data = await response.json();

                if (data.status !== 'ok') {
                    throw new Error(data.message || 'RSS parse failed');
                }

                return parseRss2JsonResponse(data, feed);
            } catch (error) {
                console.error(`Error fetching ${feed.name}:`, error);
                return [];
            }
        }

        // Parsa rss2json response format
        function parseRss2JsonResponse(data, feed) {
            const articles = [];

            (data.items || []).forEach((item, index) => {
                const cleanDesc = (item.description || '').replace(/<[^>]+>/g, '').trim();

                articles.push({
                    id: `${feed.id}-${index}-${Date.now()}`,
                    title: item.title || '',
                    link: item.link || '',
                    description: cleanDesc.substring(0, 300) + (cleanDesc.length > 300 ? '...' : ''),
                    pubDate: item.pubDate || '',
                    author: item.author || feed.name,
                    image: item.thumbnail || item.enclosure?.link || '',
                    source: feed.name,
                    sourceId: feed.id,
                    category: feed.category
                });
            });

            return articles;
        }

        function parseRSS(xml, feed) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const items = doc.querySelectorAll('item, entry');
            const articles = [];

            items.forEach((item, index) => {
                const title = item.querySelector('title')?.textContent || '';
                const link = item.querySelector('link')?.textContent ||
                    item.querySelector('link')?.getAttribute('href') || '';
                const description = item.querySelector('description, summary, content')?.textContent || '';
                const pubDate = item.querySelector('pubDate, published, updated')?.textContent || '';
                const author = item.querySelector('author, creator, dc\\:creator')?.textContent || '';

                // F√∂rs√∂k hitta bild
                let image = '';
                const enclosure = item.querySelector('enclosure[type^="image"]');
                const mediaContent = item.querySelector('media\\:content, content');
                const thumbnail = item.querySelector('media\\:thumbnail');

                if (enclosure) image = enclosure.getAttribute('url');
                else if (mediaContent && mediaContent.getAttribute('url')) image = mediaContent.getAttribute('url');
                else if (thumbnail) image = thumbnail.getAttribute('url');
                else {
                    // S√∂k i description efter img
                    const imgMatch = description.match(/<img[^>]+src="([^"]+)"/);
                    if (imgMatch) image = imgMatch[1];
                }

                // Rensa HTML fr√•n description
                const cleanDesc = description.replace(/<[^>]+>/g, '').trim();

                articles.push({
                    id: `${feed.id}-${index}-${Date.now()}`,
                    title: title.trim(),
                    link: link.trim(),
                    description: cleanDesc.substring(0, 300),
                    pubDate: pubDate ? new Date(pubDate) : new Date(),
                    author: author.trim(),
                    image: image,
                    source: feed.name,
                    sourceId: feed.id,
                    category: feed.category,
                    read: readArticles.includes(link.trim())
                });
            });

            return articles;
        }

        async function refreshAllFeeds() {
            const icon = document.getElementById('refresh-icon');
            icon.textContent = '‚è≥';
            icon.style.animation = 'spin 1s linear infinite';

            articles = [];
            const enabledFeeds = RSS_FEEDS.filter(f => f.enabled);

            // H√§mta alla feeds parallellt
            const results = await Promise.allSettled(
                enabledFeeds.map(feed => fetchFeed(feed))
            );

            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    articles = articles.concat(result.value);
                }
            });

            // Sortera efter datum
            articles.sort((a, b) => b.pubDate - a.pubDate);

            // Markera keyword-matches
            highlightKeywords();

            renderArticles();
            renderFeedsSidebar();

            icon.textContent = 'üîÑ';
            icon.style.animation = '';

            Components.showToast(`${articles.length} artiklar laddade`, 'success');
        }

        function highlightKeywords() {
            articles.forEach(article => {
                const text = (article.title + ' ' + article.description).toLowerCase();
                article.keywordMatches = keywords.filter(kw =>
                    text.includes(kw.toLowerCase())
                );
            });
        }

        // =========================================================================
        // RENDER
        // =========================================================================

        function renderFeedsSidebar() {
            const container = document.getElementById('feeds-list');
            const categories = {};

            RSS_FEEDS.forEach(feed => {
                if (!categories[feed.category]) {
                    categories[feed.category] = [];
                }
                const count = articles.filter(a => a.sourceId === feed.id).length;
                categories[feed.category].push({ ...feed, count });
            });

            const categoryNames = {
                tech: 'üíª Tech',
                finans: 'üí∞ Finans',
                nyheter: 'üì∞ Nyheter'
            };

            let html = `
                <div class="feed-source ${!currentFeed ? 'active' : ''}" onclick="selectFeed(null)">
                    <div class="feed-source-icon">üìö</div>
                    <div class="feed-source-name">Alla k√§llor</div>
                    <div class="feed-source-count">${articles.length}</div>
                </div>
            `;

            Object.entries(categories).forEach(([cat, feeds]) => {
                html += `<div class="feed-category-title">${categoryNames[cat] || cat}</div>`;
                feeds.forEach(feed => {
                    html += `
                        <div class="feed-source ${currentFeed === feed.id ? 'active' : ''}"
                             onclick="selectFeed('${feed.id}')">
                            <div class="feed-source-name">${feed.name}</div>
                            <div class="feed-source-count">${feed.count}</div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function renderArticles() {
            const container = document.getElementById('articles-list');
            let filtered = articles;

            // Filtrera p√• kategori
            if (currentCategory !== 'all') {
                filtered = filtered.filter(a => a.category === currentCategory);
            }

            // Filtrera p√• k√§lla
            if (currentFeed) {
                filtered = filtered.filter(a => a.sourceId === currentFeed);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Inga artiklar</h3>
                        <p>Inga artiklar matchade dina filter</p>
                    </div>
                `;
                return;
            }

            // Anv√§nd grid-layout f√∂r artikelkort
            container.innerHTML = `<div class="articles-grid">${filtered.map(article => {
                const hasKeywords = article.keywordMatches && article.keywordMatches.length > 0;
                const categoryIcon = getCategoryIcon(article.category);

                return `
                    <article class="article-card ${article.read ? 'read' : ''}"
                             onclick="openArticleLightbox('${article.id}')">
                        ${article.image
                            ? `<img src="${article.image}" class="article-card-image" alt="" loading="lazy" onerror="this.outerHTML='<div class=\\'article-card-image-placeholder\\'>${categoryIcon}</div>'">`
                            : `<div class="article-card-image-placeholder">${categoryIcon}</div>`
                        }
                        <div class="article-card-content">
                            <div class="article-source">
                                <span class="article-source-badge">${article.source}</span>
                                ${hasKeywords ? `<span class="keyword-match">üîî ${article.keywordMatches.join(', ')}</span>` : ''}
                            </div>
                            <h3 class="article-title">${escapeHtml(article.title)}</h3>
                            <p class="article-excerpt">${escapeHtml(article.description)}</p>
                            <div class="article-meta">
                                <span>${Utils.formatDate(article.pubDate, { relative: true })}</span>
                                ${article.author ? `<span>‚Ä¢ ${escapeHtml(article.author)}</span>` : ''}
                                <div class="article-actions">
                                    <button class="article-action-btn" onclick="event.stopPropagation(); quickBookmark('${article.id}')" title="Spara">‚≠ê</button>
                                    <button class="article-action-btn" onclick="event.stopPropagation(); quickShare('${article.id}')" title="Dela">üì§</button>
                                </div>
                            </div>
                        </div>
                    </article>
                `;
            }).join('')}</div>`;
        }

        function getCategoryIcon(category) {
            const icons = {
                'tech': 'üíª',
                'finans': 'üí∞',
                'nyheter': 'üì∞'
            };
            return icons[category] || 'üìÑ';
        }

        // =========================================================================
        // LIGHTBOX FUNCTIONS
        // =========================================================================

        function openArticleLightbox(id) {
            selectedArticle = articles.find(a => a.id === id);
            if (!selectedArticle) return;

            // Markera som l√§st
            if (!readArticles.includes(selectedArticle.link)) {
                readArticles.push(selectedArticle.link);
                Utils.setStorage('rss-read', readArticles);
                selectedArticle.read = true;
                renderArticles(); // Uppdatera UI f√∂r att visa "read" status
            }

            // Uppdatera lightbox header
            document.getElementById('lightbox-source').textContent = selectedArticle.source;
            document.getElementById('lightbox-date').textContent = Utils.formatDate(selectedArticle.pubDate, { includeTime: true });
            document.getElementById('lightbox-link').href = selectedArticle.link;

            // Rendera inneh√•llet
            const content = document.getElementById('lightbox-content');
            content.innerHTML = `
                ${selectedArticle.image ? `<img src="${selectedArticle.image}" class="lightbox-image" alt="">` : ''}
                <h1 class="lightbox-title">${escapeHtml(selectedArticle.title)}</h1>
                <div class="lightbox-meta">
                    <span>üìÖ ${Utils.formatDate(selectedArticle.pubDate, { includeTime: true })}</span>
                    ${selectedArticle.author ? `<span>‚úçÔ∏è ${escapeHtml(selectedArticle.author)}</span>` : ''}
                    <span>üìÅ ${selectedArticle.category}</span>
                </div>
                <div class="lightbox-text">
                    <p>${escapeHtml(selectedArticle.description)}</p>
                </div>
                <div class="lightbox-full-content" id="full-content-area">
                    <h4>Laddar fullst√§ndigt inneh√•ll...</h4>
                    <div class="lightbox-loading">
                        <div class="loader"></div>
                        <p class="mt-2">H√§mtar artikel...</p>
                    </div>
                </div>
            `;

            // Visa lightbox
            document.getElementById('article-lightbox').classList.add('show');
            document.body.style.overflow = 'hidden';

            // F√∂rs√∂k h√§mta fullst√§ndigt inneh√•ll via proxy
            fetchFullArticleContent(selectedArticle.link);
        }

        function closeLightbox() {
            document.getElementById('article-lightbox').classList.remove('show');
            document.body.style.overflow = '';
        }

        function closeLightboxOnBackdrop(event) {
            if (event.target.id === 'article-lightbox') {
                closeLightbox();
            }
        }

        // St√§ng med Escape-tangenten
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('article-lightbox').classList.contains('show')) {
                closeLightbox();
            }
        });

        async function fetchFullArticleContent(url) {
            const contentArea = document.getElementById('full-content-area');

            try {
                // Anv√§nd en CORS-proxy f√∂r att h√§mta inneh√•llet
                // Vi provar flera alternativ
                const proxyUrls = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                    `https://corsproxy.io/?${encodeURIComponent(url)}`
                ];

                let html = null;
                for (const proxyUrl of proxyUrls) {
                    try {
                        const response = await fetch(proxyUrl, {
                            timeout: 10000,
                            headers: {
                                'Accept': 'text/html'
                            }
                        });
                        if (response.ok) {
                            html = await response.text();
                            break;
                        }
                    } catch (e) {
                        console.warn('Proxy failed:', proxyUrl, e);
                    }
                }

                if (!html) {
                    throw new Error('Kunde inte h√§mta artikeln');
                }

                // Extrahera huvudinneh√•llet fr√•n HTML
                const cleanContent = extractArticleContent(html);

                if (cleanContent) {
                    contentArea.innerHTML = `
                        <h4>Fullst√§ndigt inneh√•ll</h4>
                        <div class="lightbox-text">${cleanContent}</div>
                    `;
                } else {
                    contentArea.innerHTML = `
                        <h4>F√∂rhandsgranskning</h4>
                        <p class="text-muted">Kunde inte extrahera fullst√§ndigt inneh√•ll. Klicka p√• "L√§s p√• originalk√§llan" f√∂r att l√§sa hela artikeln.</p>
                    `;
                }
            } catch (error) {
                console.error('Error fetching article:', error);
                contentArea.innerHTML = `
                    <h4>F√∂rhandsgranskning</h4>
                    <p class="text-muted">Kunde inte h√§mta fullst√§ndigt inneh√•ll. Klicka p√• "L√§s p√• originalk√§llan" f√∂r att l√§sa hela artikeln.</p>
                `;
            }
        }

        function extractArticleContent(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Ta bort st√∂rande element
                const removeSelectors = [
                    'script', 'style', 'nav', 'header', 'footer', 'aside',
                    '.ad', '.ads', '.advertisement', '.cookie', '.cookies',
                    '.popup', '.modal', '.newsletter', '.subscribe',
                    '.social', '.share', '.comments', '.related',
                    '[class*="cookie"]', '[class*="consent"]', '[class*="gdpr"]',
                    '[class*="banner"]', '[class*="popup"]', '[class*="modal"]',
                    '[id*="cookie"]', '[id*="consent"]', '[id*="gdpr"]',
                    'iframe', 'video', 'audio'
                ];

                removeSelectors.forEach(selector => {
                    doc.querySelectorAll(selector).forEach(el => el.remove());
                });

                // F√∂rs√∂k hitta huvudinneh√•llet med vanliga selectors
                const contentSelectors = [
                    'article',
                    '[class*="article-body"]',
                    '[class*="article-content"]',
                    '[class*="post-content"]',
                    '[class*="entry-content"]',
                    '[class*="story-body"]',
                    '[class*="article__body"]',
                    '.content',
                    'main',
                    '[role="main"]'
                ];

                let content = null;
                for (const selector of contentSelectors) {
                    const el = doc.querySelector(selector);
                    if (el && el.textContent.trim().length > 200) {
                        content = el;
                        break;
                    }
                }

                if (!content) {
                    // Fallback: ta alla paragrafer
                    const paragraphs = doc.querySelectorAll('p');
                    if (paragraphs.length > 0) {
                        const div = doc.createElement('div');
                        paragraphs.forEach(p => {
                            if (p.textContent.trim().length > 50) {
                                div.appendChild(p.cloneNode(true));
                            }
                        });
                        if (div.textContent.trim().length > 200) {
                            content = div;
                        }
                    }
                }

                if (content) {
                    // Rensa upp inneh√•llet
                    content.querySelectorAll('a').forEach(a => {
                        a.removeAttribute('href');
                        a.style.color = 'inherit';
                        a.style.textDecoration = 'none';
                    });

                    // Beh√•ll endast text och bilder
                    const cleanHTML = content.innerHTML
                        .replace(/<img[^>]*>/gi, '') // Ta bort bilder (kan visa originalbilden ist√§llet)
                        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                        .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');

                    return cleanHTML;
                }

                return null;
            } catch (e) {
                console.error('Error extracting content:', e);
                return null;
            }
        }

        // Snabb√•tg√§rder f√∂r artikelkort
        function quickBookmark(id) {
            const article = articles.find(a => a.id === id);
            if (article) {
                Components.showToast(`"${article.title.substring(0, 30)}..." sparad ‚≠ê`, 'success');
            }
        }

        function quickShare(id) {
            const article = articles.find(a => a.id === id);
            if (article) {
                if (navigator.share) {
                    navigator.share({ title: article.title, url: article.link });
                } else {
                    Utils.copyToClipboard(article.link);
                    Components.showToast('L√§nk kopierad!', 'success');
                }
            }
        }

        // =========================================================================
        // ACTIONS
        // =========================================================================

        function selectFeed(feedId) {
            currentFeed = feedId;
            renderFeedsSidebar();
            renderArticles();

            const feedName = feedId ? RSS_FEEDS.find(f => f.id === feedId)?.name : 'Alla nyheter';
            document.getElementById('articles-title').textContent = feedName;
        }

        function filterByCategory(category) {
            currentCategory = category;

            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });

            renderArticles();
        }

        function bookmarkArticle() {
            if (!selectedArticle) return;
            Components.showToast('Artikel sparad ‚≠ê', 'success');
        }

        function shareArticle() {
            if (!selectedArticle) return;

            if (navigator.share) {
                navigator.share({
                    title: selectedArticle.title,
                    url: selectedArticle.link
                });
            } else {
                Utils.copyToClipboard(selectedArticle.link);
                Components.showToast('L√§nk kopierad!', 'success');
            }
        }

        function investigateArticle() {
            if (!selectedArticle) return;
            // √ñppna i f√∂retagsbevakning med s√∂kning p√• eventuellt f√∂retagsnamn
            const query = encodeURIComponent(selectedArticle.title.split(' ').slice(0, 3).join(' '));
            window.open(`../../bevakning/foretagslista/?search=${query}`, '_blank');
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('show');
            if (modal.classList.contains('show')) {
                renderKeywords();
            }
        }

        function renderKeywords() {
            const container = document.getElementById('keywords-list');
            if (keywords.length === 0) {
                container.innerHTML = '<p class="text-muted text-sm">Inga nyckelord tillagda</p>';
                return;
            }

            container.innerHTML = keywords.map(kw => `
                <span class="badge badge-member mr-2 mb-2" style="display: inline-flex; align-items: center; gap: 4px;">
                    ${escapeHtml(kw)}
                    <button onclick="removeKeyword('${escapeHtml(kw)}')" style="background:none;border:none;cursor:pointer;padding:0;margin-left:4px;">√ó</button>
                </span>
            `).join('');
        }

        function addKeyword() {
            const input = document.getElementById('new-keyword');
            const kw = input.value.trim().toLowerCase();

            if (kw && !keywords.includes(kw)) {
                keywords.push(kw);
                Utils.setStorage('rss-keywords', keywords);
                highlightKeywords();
                renderKeywords();
                renderArticles();
            }

            input.value = '';
        }

        function removeKeyword(kw) {
            keywords = keywords.filter(k => k !== kw);
            Utils.setStorage('rss-keywords', keywords);
            highlightKeywords();
            renderKeywords();
            renderArticles();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // =========================================================================
        // INIT
        // =========================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            // Kolla auth
            const user = await Auth.getUser();
            if (!user) {
                window.location.href = '../../';
                return;
            }

            // Event listeners
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => filterByCategory(tab.dataset.category));
            });

            document.getElementById('sort-select').addEventListener('change', (e) => {
                if (e.target.value === 'oldest') {
                    articles.sort((a, b) => a.pubDate - b.pubDate);
                } else {
                    articles.sort((a, b) => b.pubDate - a.pubDate);
                }
                renderArticles();
            });

            document.getElementById('new-keyword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addKeyword();
            });

            // Ladda feeds
            await refreshAllFeeds();
        });
    </script>
</body>
</html>
