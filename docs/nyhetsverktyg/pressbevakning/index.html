<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pressbevakning - Bevakningsverktyget</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/reset.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/layout.css">
    <link rel="stylesheet" href="../../assets/css/utilities.css">
    <style>
        body { background: var(--gray-100); }

        .press-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-6);
        }

        .press-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-6);
            flex-wrap: wrap;
            gap: var(--spacing-4);
        }

        .press-header h1 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
        }

        /* Pressroom cards */
        .pressrooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-8);
        }

        .pressroom-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-300);
            padding: var(--spacing-5);
            transition: all var(--transition-base);
        }

        .pressroom-card:hover {
            border-color: var(--dark);
            box-shadow: var(--shadow-md);
        }

        .pressroom-card.active {
            border-color: var(--accent);
            border-width: 2px;
        }

        .pressroom-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }

        .pressroom-logo {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .pressroom-info { flex: 1; }

        .pressroom-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-lg);
        }

        .pressroom-url {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
        }

        .pressroom-stats {
            display: flex;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
            font-size: var(--font-size-sm);
        }

        .pressroom-stat {
            color: var(--gray-500);
        }

        .pressroom-stat strong {
            color: var(--dark);
        }

        .pressroom-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        /* Add pressroom form */
        .add-pressroom-card {
            background: var(--gray-100);
            border: 2px dashed var(--gray-300);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .add-pressroom-card:hover {
            border-color: var(--accent);
            background: var(--accent-muted);
        }

        .add-pressroom-icon {
            font-size: 32px;
            margin-bottom: var(--spacing-2);
        }

        /* Releases section */
        .releases-section {
            margin-top: var(--spacing-8);
        }

        .releases-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-4);
        }

        .releases-header h2 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
        }

        .releases-grid {
            display: grid;
            gap: var(--spacing-4);
        }

        .release-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-300);
            overflow: hidden;
            display: grid;
            grid-template-columns: 200px 1fr;
            transition: all var(--transition-base);
        }

        .release-card:hover {
            border-color: var(--dark);
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 768px) {
            .release-card {
                grid-template-columns: 1fr;
            }
            .release-image { height: 150px; }
        }

        .release-image {
            background: var(--gray-100);
            background-size: cover;
            background-position: center;
        }

        .release-content {
            padding: var(--spacing-5);
        }

        .release-source {
            display: inline-block;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-2);
        }

        .release-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-snug);
            margin-bottom: var(--spacing-2);
        }

        .release-excerpt {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            line-height: var(--line-height-normal);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: var(--spacing-3);
        }

        .release-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            font-size: var(--font-size-xs);
            color: var(--gray-500);
        }

        .release-actions {
            margin-top: var(--spacing-4);
            display: flex;
            gap: var(--spacing-2);
        }

        /* Filters */
        .filter-bar {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
            flex-wrap: wrap;
        }

        .filter-bar input {
            flex: 1;
            min-width: 250px;
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="dashboard-nav">
        <div class="nav-inner">
            <div class="d-flex items-center gap-4">
                <a href="../../" class="nav-brand">Bevakningsverktyget</a>
                <span class="text-muted">‚Ä∫</span>
                <span class="font-medium">Pressbevakning</span>
            </div>
            <div class="nav-right">
                <button class="btn btn-accent btn-sm" onclick="refreshAll()">
                    <span id="refresh-icon">üîÑ</span> H√§mta nya
                </button>
                <a href="../../" class="btn btn-ghost btn-sm">‚Üê Tillbaka</a>
            </div>
        </div>
    </nav>

    <div class="press-container">
        <div class="press-header">
            <div>
                <h1>Pressbevakning</h1>
                <p class="text-muted mt-1">Bevaka pressmeddelanden fr√•n f√∂retag via MyNewsdesk</p>
            </div>
        </div>

        <!-- Bevakade pressrum -->
        <section>
            <h2 class="font-semibold mb-4">Bevakade pressrum</h2>
            <div class="pressrooms-grid" id="pressrooms-grid">
                <!-- Filled by JS -->
            </div>
        </section>

        <!-- Senaste pressmeddelanden -->
        <section class="releases-section">
            <div class="releases-header">
                <h2>
                    <span class="live-dot"></span>
                    Senaste pressmeddelanden
                </h2>
                <span class="text-muted text-sm" id="releases-count">0 pressmeddelanden</span>
            </div>

            <div class="filter-bar">
                <input type="text" id="search-releases" placeholder="S√∂k i pressmeddelanden...">
                <select id="filter-source" class="btn btn-secondary btn-sm">
                    <option value="">Alla k√§llor</option>
                </select>
            </div>

            <div class="releases-grid" id="releases-grid">
                <div class="empty-state">
                    <div class="loader loader-lg"></div>
                    <p class="mt-4">H√§mtar pressmeddelanden...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Pressroom Modal -->
    <div class="modal" id="add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">L√§gg till pressrum</h3>
                <button class="modal-close" onclick="closeAddModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>MyNewsdesk URL eller f√∂retagsnamn</label>
                    <input type="text" id="pressroom-url" placeholder="https://www.mynewsdesk.com/se/foretag">
                </div>
                <p class="text-sm text-muted">
                    Exempel: https://www.mynewsdesk.com/se/northvolt
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddModal()">Avbryt</button>
                <button class="btn btn-accent" onclick="addPressroom()">L√§gg till</button>
            </div>
        </div>
    </div>

    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/api.js"></script>
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/components.js"></script>
    <script>
        // =========================================================================
        // PRESSBEVAKNING - MyNewsdesk integration
        // =========================================================================

        // Default pressrooms att bevaka (kan ut√∂kas av anv√§ndaren)
        const DEFAULT_PRESSROOMS = [
            { id: 'northvolt', name: 'Northvolt', url: 'https://www.mynewsdesk.com/se/northvolt', logo: 'üîã' },
            { id: 'klarna', name: 'Klarna', url: 'https://www.mynewsdesk.com/se/klarna', logo: 'üí≥' },
            { id: 'spotify', name: 'Spotify', url: 'https://newsroom.spotify.com/feed/', logo: 'üéµ', isRss: true },
            { id: 'vattenfall', name: 'Vattenfall', url: 'https://www.mynewsdesk.com/se/vattenfall', logo: '‚ö°' },
            { id: 'volvo', name: 'Volvo Group', url: 'https://www.mynewsdesk.com/se/volvogroup', logo: 'üöõ' }
        ];

        // RSS2JSON API - konverterar RSS till JSON och hanterar CORS
        const RSS2JSON_API = 'https://api.rss2json.com/v1/api.json?rss_url=';

        // State
        let pressrooms = Utils.getStorage('pressrooms', DEFAULT_PRESSROOMS);
        let releases = [];
        let searchTerm = '';
        let filterSource = '';

        // =========================================================================
        // FETCH MYNEWSDESK
        // =========================================================================

        async function fetchPressroom(pressroom) {
            try {
                // MyNewsdesk har RSS feeds p√• /rss/current_news/{id}
                const rssUrl = pressroom.url.includes('/rss/')
                    ? pressroom.url
                    : `${pressroom.url}/rss/pressreleases`;

                const apiUrl = RSS2JSON_API + encodeURIComponent(rssUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) throw new Error('Fetch failed');

                const data = await response.json();

                if (data.status !== 'ok') {
                    throw new Error(data.message || 'RSS parse failed');
                }

                return parseRss2JsonResponse(data, pressroom);
            } catch (error) {
                console.error(`Error fetching ${pressroom.name}:`, error);
                return [];
            }
        }

        // Parsa rss2json response format
        function parseRss2JsonResponse(data, pressroom) {
            const releases = [];

            (data.items || []).forEach((item, index) => {
                const cleanDesc = (item.description || '').replace(/<[^>]+>/g, '').trim();

                releases.push({
                    id: `${pressroom.id}-${index}-${Date.now()}`,
                    title: (item.title || '').trim(),
                    link: (item.link || '').trim(),
                    description: cleanDesc.substring(0, 300),
                    pubDate: item.pubDate ? new Date(item.pubDate) : new Date(),
                    image: item.thumbnail || item.enclosure?.link || '',
                    source: pressroom.name,
                    sourceId: pressroom.id,
                    sourceLogo: pressroom.logo
                });
            });

            return releases;
        }

        function parseRSS(xml, pressroom) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = doc.querySelectorAll('item');
                const releases = [];

                items.forEach((item, index) => {
                    const title = item.querySelector('title')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const description = item.querySelector('description')?.textContent || '';
                    const pubDate = item.querySelector('pubDate')?.textContent || '';

                    // F√∂rs√∂k hitta bild
                    let image = '';
                    const enclosure = item.querySelector('enclosure[type^="image"]');
                    if (enclosure) {
                        image = enclosure.getAttribute('url');
                    } else {
                        const imgMatch = description.match(/<img[^>]+src="([^"]+)"/);
                        if (imgMatch) image = imgMatch[1];
                    }

                    // Rensa HTML fr√•n description
                    const cleanDesc = description.replace(/<[^>]+>/g, '').trim();

                    releases.push({
                        id: `${pressroom.id}-${index}-${Date.now()}`,
                        title: title.trim(),
                        link: link.trim(),
                        description: cleanDesc.substring(0, 300),
                        pubDate: pubDate ? new Date(pubDate) : new Date(),
                        image: image,
                        source: pressroom.name,
                        sourceId: pressroom.id,
                        sourceLogo: pressroom.logo
                    });
                });

                return releases;
            } catch (e) {
                console.error('Parse error:', e);
                return [];
            }
        }

        async function refreshAll() {
            const icon = document.getElementById('refresh-icon');
            icon.textContent = '‚è≥';
            icon.style.animation = 'spin 1s linear infinite';

            releases = [];

            const results = await Promise.allSettled(
                pressrooms.map(pr => fetchPressroom(pr))
            );

            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    releases = releases.concat(result.value);
                }
            });

            // Sortera efter datum
            releases.sort((a, b) => b.pubDate - a.pubDate);

            renderReleases();
            updateSourceFilter();

            icon.textContent = 'üîÑ';
            icon.style.animation = '';

            Components.showToast(`${releases.length} pressmeddelanden h√§mtade`, 'success');
        }

        // =========================================================================
        // RENDER
        // =========================================================================

        function renderPressrooms() {
            const grid = document.getElementById('pressrooms-grid');

            let html = pressrooms.map(pr => `
                <div class="pressroom-card" data-id="${pr.id}">
                    <div class="pressroom-header">
                        <div class="pressroom-logo">${pr.logo || 'üì∞'}</div>
                        <div class="pressroom-info">
                            <div class="pressroom-name">${escapeHtml(pr.name)}</div>
                            <div class="pressroom-url">${escapeHtml(pr.url.replace('https://www.mynewsdesk.com/se/', ''))}</div>
                        </div>
                    </div>
                    <div class="pressroom-stats">
                        <span class="pressroom-stat">
                            <strong>${releases.filter(r => r.sourceId === pr.id).length}</strong> releaser
                        </span>
                    </div>
                    <div class="pressroom-actions">
                        <a href="${pr.url}" target="_blank" class="btn btn-secondary btn-sm">Bes√∂k</a>
                        <button class="btn btn-ghost btn-sm" onclick="removePressroom('${pr.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            // Add button
            html += `
                <div class="pressroom-card add-pressroom-card" onclick="openAddModal()">
                    <div class="add-pressroom-icon">‚ûï</div>
                    <span class="font-medium">L√§gg till pressrum</span>
                </div>
            `;

            grid.innerHTML = html;
        }

        function renderReleases() {
            const grid = document.getElementById('releases-grid');
            let filtered = releases;

            // S√∂kfilter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(r =>
                    r.title.toLowerCase().includes(term) ||
                    r.description.toLowerCase().includes(term)
                );
            }

            // K√§llfilter
            if (filterSource) {
                filtered = filtered.filter(r => r.sourceId === filterSource);
            }

            document.getElementById('releases-count').textContent = `${filtered.length} pressmeddelanden`;

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Inga pressmeddelanden</h3>
                        <p>Inga pressmeddelanden matchade dina filter</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.slice(0, 20).map(release => `
                <div class="release-card">
                    <div class="release-image" style="background-image: url('${release.image || ''}');
                        ${!release.image ? 'display: flex; align-items: center; justify-content: center; font-size: 48px;' : ''}">
                        ${!release.image ? release.sourceLogo || 'üì∞' : ''}
                    </div>
                    <div class="release-content">
                        <span class="release-source">${release.sourceLogo || 'üì∞'} ${escapeHtml(release.source)}</span>
                        <h3 class="release-title">${escapeHtml(release.title)}</h3>
                        <p class="release-excerpt">${escapeHtml(release.description)}</p>
                        <div class="release-meta">
                            <span>üìÖ ${Utils.formatDate(release.pubDate, { relative: true })}</span>
                        </div>
                        <div class="release-actions">
                            <a href="${release.link}" target="_blank" class="btn btn-accent btn-sm">
                                L√§s pressmeddelande ‚Üí
                            </a>
                            <button class="btn btn-secondary btn-sm" onclick="investigateRelease('${escapeHtml(release.source)}')">
                                üîç Unders√∂k f√∂retag
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateSourceFilter() {
            const select = document.getElementById('filter-source');
            const sources = [...new Set(releases.map(r => r.sourceId))];

            select.innerHTML = '<option value="">Alla k√§llor</option>' +
                sources.map(id => {
                    const pr = pressrooms.find(p => p.id === id);
                    return `<option value="${id}">${pr?.name || id}</option>`;
                }).join('');
        }

        // =========================================================================
        // ACTIONS
        // =========================================================================

        function openAddModal() {
            document.getElementById('add-modal').classList.add('show');
            document.getElementById('pressroom-url').focus();
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('show');
            document.getElementById('pressroom-url').value = '';
        }

        async function addPressroom() {
            const input = document.getElementById('pressroom-url');
            let url = input.value.trim();

            if (!url) {
                Components.showToast('Ange en URL', 'error');
                return;
            }

            // L√§gg till base URL om det bara √§r ett namn
            if (!url.startsWith('http')) {
                url = `https://www.mynewsdesk.com/se/${url.toLowerCase().replace(/\s+/g, '-')}`;
            }

            // Extrahera namn fr√•n URL
            const parts = url.split('/');
            const name = parts[parts.length - 1].replace(/-/g, ' ');
            const id = parts[parts.length - 1];

            // Kolla om redan tillagd
            if (pressrooms.find(p => p.id === id)) {
                Components.showToast('Pressrummet finns redan', 'warning');
                return;
            }

            const newPressroom = {
                id: id,
                name: name.charAt(0).toUpperCase() + name.slice(1),
                url: url,
                logo: 'üì∞'
            };

            pressrooms.push(newPressroom);
            Utils.setStorage('pressrooms', pressrooms);

            closeAddModal();
            renderPressrooms();

            // H√§mta releases f√∂r det nya pressrummet
            Components.showToast('Pressrum tillagt! H√§mtar releaser...', 'success');

            const newReleases = await fetchPressroom(newPressroom);
            releases = releases.concat(newReleases);
            releases.sort((a, b) => b.pubDate - a.pubDate);

            renderReleases();
            updateSourceFilter();
        }

        function removePressroom(id) {
            if (!confirm('Ta bort detta pressrum?')) return;

            pressrooms = pressrooms.filter(p => p.id !== id);
            Utils.setStorage('pressrooms', pressrooms);

            releases = releases.filter(r => r.sourceId !== id);

            renderPressrooms();
            renderReleases();
            updateSourceFilter();

            Components.showToast('Pressrum borttaget', 'success');
        }

        function investigateRelease(companyName) {
            const query = encodeURIComponent(companyName);
            window.open(`../../bevakning/foretagslista/?search=${query}`, '_blank');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // =========================================================================
        // INIT
        // =========================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            // Kolla auth
            const user = await Auth.getUser();
            if (!user) {
                window.location.href = '../../';
                return;
            }

            // Event listeners
            document.getElementById('search-releases').addEventListener('input', Utils.debounce((e) => {
                searchTerm = e.target.value;
                renderReleases();
            }, 300));

            document.getElementById('filter-source').addEventListener('change', (e) => {
                filterSource = e.target.value;
                renderReleases();
            });

            document.getElementById('pressroom-url').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addPressroom();
            });

            // Render & fetch
            renderPressrooms();
            await refreshAll();
        });
    </script>
</body>
</html>
