<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bevakningsverktyget - Loop Impact</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="assets/css/variables.css">
    <link rel="stylesheet" href="assets/css/reset.css">
    <style>
        /* ========================================================================
           MINIMAL DASHBOARD DESIGN
           ======================================================================== */

        :root {
            --sidebar-width: 64px;
            --sidebar-expanded: 280px;
            --nav-height: 56px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50, #f8fafc);
            color: var(--dark, #1a1a2e);
            line-height: 1.5;
        }

        /* ========================================================================
           LOGIN PAGE
           ======================================================================== */
        .login-page {
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr 480px;
        }

        .login-hero {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4rem;
        }

        .login-hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1.1;
            margin-bottom: 1.5rem;
        }

        .login-hero p {
            font-size: 1.125rem;
            opacity: 0.8;
            max-width: 400px;
        }

        .login-form-container {
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4rem;
        }

        .login-logo {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #64748b;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #94a3b8;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            gap: 0.5rem;
        }

        .btn-primary {
            width: 100%;
            background: #1a1a2e;
            color: white;
        }

        .btn-primary:hover {
            background: #16213e;
        }

        .btn-ghost {
            background: transparent;
            color: #64748b;
        }

        .btn-ghost:hover {
            background: #f1f5f9;
            color: #1a1a2e;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        .alert.show { display: block; }
        .alert-error { background: #fef2f2; color: #dc2626; }
        .alert-success { background: #f0fdf4; color: #16a34a; }

        .login-footer {
            margin-top: 2rem;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .login-page.hide { display: none; }

        @media (max-width: 900px) {
            .login-page { grid-template-columns: 1fr; }
            .login-hero { display: none; }
        }

        /* ========================================================================
           DASHBOARD LAYOUT
           ======================================================================== */
        #dashboard {
            display: none;
            min-height: 100vh;
        }

        #dashboard.show { display: block; }

        /* Navigation */
        .nav {
            height: var(--nav-height);
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            font-weight: 600;
            font-size: 1rem;
            color: #1a1a2e;
            text-decoration: none;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.375rem 0.75rem 0.375rem 0.375rem;
            background: #f8fafc;
            border-radius: 100px;
            font-size: 0.875rem;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #1a1a2e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: flex;
            min-height: calc(100vh - var(--nav-height));
        }

        /* ========================================================================
           ICON SIDEBAR
           ======================================================================== */
        .icon-sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            gap: 0.25rem;
            position: sticky;
            top: var(--nav-height);
            height: calc(100vh - var(--nav-height));
        }

        .sidebar-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 1.25rem;
            color: #64748b;
            position: relative;
            background: transparent;
            border: none;
        }

        .sidebar-icon:hover {
            background: #f1f5f9;
            color: #1a1a2e;
        }

        .sidebar-icon.active {
            background: #1a1a2e;
            color: white;
        }

        .sidebar-icon-tooltip {
            position: absolute;
            left: calc(100% + 12px);
            background: #1a1a2e;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            pointer-events: none;
            z-index: 50;
        }

        .sidebar-icon:hover .sidebar-icon-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-divider {
            width: 32px;
            height: 1px;
            background: #e2e8f0;
            margin: 0.5rem 0;
        }

        .sidebar-spacer {
            flex: 1;
        }

        /* Expanded Sidebar Panel */
        .sidebar-panel {
            position: fixed;
            top: var(--nav-height);
            left: var(--sidebar-width);
            width: calc(var(--sidebar-expanded) - var(--sidebar-width));
            height: calc(100vh - var(--nav-height));
            background: white;
            border-right: 1px solid #e2e8f0;
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 40;
            overflow-y: auto;
            padding: 1rem;
        }

        .sidebar-panel.open {
            transform: translateX(0);
            opacity: 1;
        }

        .panel-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.75rem;
            padding: 0 0.5rem;
        }

        .panel-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 8px;
            text-decoration: none;
            color: #1a1a2e;
            font-size: 0.875rem;
            transition: background 0.15s;
        }

        .panel-link:hover {
            background: #f1f5f9;
        }

        .panel-link-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .panel-link:hover .panel-link-icon {
            background: #e2e8f0;
        }

        /* ========================================================================
           MAIN CONTENT
           ======================================================================== */
        .main-content {
            flex: 1;
            padding: 1.5rem 2rem;
            max-width: 900px;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 100px;
            font-size: 0.8125rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-chip:hover {
            border-color: #94a3b8;
            color: #1a1a2e;
        }

        .filter-chip.active {
            background: #1a1a2e;
            border-color: #1a1a2e;
            color: white;
        }

        .filter-chip .count {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            background: rgba(0,0,0,0.1);
            border-radius: 100px;
        }

        .filter-chip.active .count {
            background: rgba(255,255,255,0.2);
        }

        .filter-spacer { flex: 1; }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.8125rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .refresh-btn:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        /* Feed */
        .feed-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Company Card (Grouped) */
        .company-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: box-shadow 0.15s;
        }

        .company-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .company-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            cursor: pointer;
        }

        .company-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .company-info {
            flex: 1;
            min-width: 0;
        }

        .company-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: #1a1a2e;
            margin-bottom: 0.125rem;
        }

        .company-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
            color: #94a3b8;
        }

        .company-orgnr {
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.75rem;
        }

        .company-time {
            font-size: 0.8125rem;
            color: #94a3b8;
            white-space: nowrap;
        }

        .event-count-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f1f5f9;
            border-radius: 100px;
            font-size: 0.75rem;
            color: #64748b;
        }

        /* Event List */
        .event-list {
            border-top: 1px solid #f1f5f9;
        }

        .event-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f8fafc;
            transition: background 0.1s;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-item:hover {
            background: #fafbfc;
        }

        .event-type-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .event-type-indicator.konkurs { background: #ef4444; }
        .event-type-indicator.kallelse { background: #f59e0b; }
        .event-type-indicator.likvidation { background: #ef4444; }
        .event-type-indicator.skuld { background: #f97316; }
        .event-type-indicator.styrelse { background: #3b82f6; }
        .event-type-indicator.fusion { background: #8b5cf6; }
        .event-type-indicator.news { background: #10b981; }
        .event-type-indicator.press { background: #06b6d4; }
        .event-type-indicator.default { background: #94a3b8; }

        .event-content {
            flex: 1;
            min-width: 0;
        }

        .event-title {
            font-size: 0.875rem;
            color: #1a1a2e;
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .event-tag {
            display: inline-flex;
            padding: 0.125rem 0.375rem;
            background: #f1f5f9;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .event-tag.konkurs { background: #fef2f2; color: #dc2626; }
        .event-tag.kallelse { background: #fffbeb; color: #d97706; }
        .event-tag.likvidation { background: #fef2f2; color: #dc2626; }
        .event-tag.skuld { background: #fff7ed; color: #ea580c; }
        .event-tag.news { background: #ecfdf5; color: #059669; }
        .event-tag.press { background: #ecfeff; color: #0891b2; }

        .event-link {
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.8125rem;
            white-space: nowrap;
        }

        .event-link:hover {
            text-decoration: underline;
        }

        /* Single Event Card */
        .single-event-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            transition: box-shadow 0.15s;
        }

        .single-event-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: #64748b;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        /* Loading */
        .loader {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top-color: #1a1a2e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================================================
           MODAL
           ======================================================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 1rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 560px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            color: #64748b;
        }

        .modal-close:hover {
            background: #e2e8f0;
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #1a1a2e;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Detail sections in modal */
        .detail-section {
            margin-bottom: 1.25rem;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            font-size: 0.875rem;
        }

        .detail-label {
            color: #64748b;
        }

        .detail-value {
            color: #1a1a2e;
            font-weight: 500;
        }

        /* ========================================================================
           RESPONSIVE
           ======================================================================== */
        @media (max-width: 768px) {
            .icon-sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                height: auto;
                width: 100%;
                flex-direction: row;
                justify-content: space-around;
                padding: 0.5rem 0;
                border-right: none;
                border-top: 1px solid #e2e8f0;
                z-index: 100;
            }

            .sidebar-divider, .sidebar-spacer {
                display: none;
            }

            .sidebar-icon-tooltip {
                display: none;
            }

            .sidebar-panel {
                display: none;
            }

            .main-content {
                padding: 1rem;
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="login-form">
        <div class="login-hero">
            <h1>Bevaka.<br>Analysera.<br>Publicera.</h1>
            <p>1214 impact-f√∂retag under bevakning. Realtidsnotifikationer om bolagsh√§ndelser. Nyhetsbevakning f√∂r journalister.</p>
        </div>
        <div class="login-form-container">
            <div class="login-logo">Bevakningsverktyget</div>
            <h2 class="login-title">V√§lkommen tillbaka</h2>
            <p class="login-subtitle">Logga in f√∂r att forts√§tta</p>
            <div class="alert alert-error" id="error"></div>
            <div class="alert alert-success" id="success"></div>
            <form id="login-form-element">
                <div class="form-group">
                    <label for="email">E-postadress</label>
                    <input type="email" id="email" placeholder="namn@foretag.se" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">L√∂senord</label>
                    <input type="password" id="password" placeholder="Ange l√∂senord" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="submit-btn">Logga in</button>
            </form>
            <div class="login-footer">
                <p>Loop Impact - Bevakningsredaktionen</p>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <nav class="nav">
            <a href="./" class="nav-brand">Bevakningsverktyget</a>
            <div class="nav-right">
                <div class="user-pill">
                    <div class="user-avatar" id="user-avatar">IS</div>
                    <span id="user-email-display"></span>
                </div>
                <button class="btn btn-ghost" id="logout-btn">Logga ut</button>
            </div>
        </nav>

        <div class="dashboard-grid">
            <!-- Icon Sidebar -->
            <aside class="icon-sidebar">
                <button class="sidebar-icon active" data-panel="feed" title="Fl√∂de">
                    üì°
                    <span class="sidebar-icon-tooltip">Realtidsfl√∂de</span>
                </button>
                <button class="sidebar-icon" data-panel="companies" title="F√∂retag">
                    üè¢
                    <span class="sidebar-icon-tooltip">F√∂retagslista</span>
                </button>
                <button class="sidebar-icon" data-panel="tools" title="Verktyg">
                    üîß
                    <span class="sidebar-icon-tooltip">Verktyg</span>
                </button>

                <div class="sidebar-divider"></div>

                <button class="sidebar-icon" data-panel="notifications" title="Notiser">
                    üîî
                    <span class="sidebar-icon-tooltip">SMS-notiser</span>
                </button>

                <div class="sidebar-spacer"></div>

                <button class="sidebar-icon" data-panel="settings" title="Inst√§llningar">
                    ‚öôÔ∏è
                    <span class="sidebar-icon-tooltip">Inst√§llningar</span>
                </button>
            </aside>

            <!-- Expanded Sidebar Panels -->
            <div class="sidebar-panel" id="panel-companies">
                <div class="panel-title">F√∂retagsbevakning</div>
                <a href="verktyg/foretagsbevakning/" class="panel-link">
                    <div class="panel-link-icon">üìã</div>
                    Bolagsh√§ndelser
                </a>
                <a href="verktyg/foretagsbevakning/#companies" class="panel-link">
                    <div class="panel-link-icon">üè¢</div>
                    F√∂retagslista (1214)
                </a>
                <a href="verktyg/allabolag/" class="panel-link">
                    <div class="panel-link-icon">üîç</div>
                    Allabolag S√∂kning
                </a>
                <a href="verktyg/bolagsverket-api/" class="panel-link">
                    <div class="panel-link-icon">üìÑ</div>
                    Bolagsverket API
                </a>
            </div>

            <div class="sidebar-panel" id="panel-tools">
                <div class="panel-title">Verktyg</div>
                <a href="nyhetsverktyg/nyhetsflode/" class="panel-link">
                    <div class="panel-link-icon">üì∞</div>
                    Nyhetsfl√∂de
                </a>
                <a href="verktyg/xbrl-parser/" class="panel-link">
                    <div class="panel-link-icon">üìä</div>
                    XBRL Parser
                </a>
                <a href="verktyg/artikelgenerator/" class="panel-link">
                    <div class="panel-link-icon">‚úçÔ∏è</div>
                    Artikelgenerator
                </a>
                <a href="verktyg/pdf-parser/" class="panel-link">
                    <div class="panel-link-icon">üìÑ</div>
                    PDF-parser
                </a>
                <a href="verktyg/pressbilder/" class="panel-link">
                    <div class="panel-link-icon">üì∏</div>
                    Pressbilder
                </a>
            </div>

            <div class="sidebar-panel" id="panel-notifications">
                <div class="panel-title">Notifikationer</div>
                <a href="sms-notiser/" class="panel-link">
                    <div class="panel-link-icon">üì±</div>
                    SMS-notiser
                </a>
            </div>

            <div class="sidebar-panel" id="panel-settings">
                <div class="panel-title">Inst√§llningar</div>
                <a href="installningar/" class="panel-link">
                    <div class="panel-link-icon">üë§</div>
                    Profil
                </a>
                <a href="admin/budget/" class="panel-link">
                    <div class="panel-link-icon">üí∞</div>
                    Budget & K√∂p
                </a>
            </div>

            <!-- Main Content - Unified Feed -->
            <main class="main-content">
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <button class="filter-chip active" data-filter="all">
                        Alla <span class="count" id="count-all">0</span>
                    </button>
                    <button class="filter-chip" data-filter="poit">
                        Bolagsh√§ndelser <span class="count" id="count-poit">0</span>
                    </button>
                    <button class="filter-chip" data-filter="news">
                        Nyheter <span class="count" id="count-news">0</span>
                    </button>
                    <button class="filter-chip" data-filter="press">
                        Press <span class="count" id="count-press">0</span>
                    </button>

                    <div class="filter-spacer"></div>

                    <button class="refresh-btn" id="refresh-btn">
                        ‚Üª Uppdatera
                    </button>
                </div>

                <!-- Feed -->
                <div class="feed-container" id="feed-container">
                    <div class="empty-state">
                        <div class="loader"></div>
                        <p>Laddar h√§ndelser...</p>
                    </div>
                </div>

                <!-- Load More -->
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" id="load-more-btn" style="display: none;">
                        Ladda fler h√§ndelser
                    </button>
                </div>
            </main>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">H√§ndelsedetaljer</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-secondary" id="modal-close-btn">St√§ng</button>
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script>
        // =========================================================================
        // STATE
        // =========================================================================
        let sb = null;
        let currentUser = null;
        let allEvents = [];          // Combined events (POIT + News)
        let filteredEvents = [];
        let currentFilter = 'all';
        let currentOffset = 0;
        const pageSize = 30;
        let companyData = {};        // orgnr -> company info
        let newsItems = [];
        let poitEvents = [];

        // RSS feeds (samma som nyhetsfl√∂de)
        const RSS_FEEDS = [
            { name: 'Breakit', url: 'https://www.breakit.se/feed/artiklar', type: 'news' },
            { name: 'DI Digital', url: 'https://www.di.se/rss/nyheter/', type: 'news' },
            { name: 'Ny Teknik', url: 'https://www.nyteknik.se/feed', type: 'news' }
        ];

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        async function initSupabase() {
            try {
                sb = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                const { data: { session } } = await sb.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await showDashboard();
                }
            } catch (error) {
                console.error('Supabase init error:', error);
            }
        }

        // =========================================================================
        // AUTHENTICATION
        // =========================================================================
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitBtn = document.getElementById('submit-btn');
            const errorEl = document.getElementById('error');
            const successEl = document.getElementById('success');

            errorEl.classList.remove('show');
            successEl.classList.remove('show');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Loggar in...';

            try {
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = data.user;
                successEl.textContent = 'Inloggning lyckades!';
                successEl.classList.add('show');
                setTimeout(() => showDashboard(), 300);
            } catch (error) {
                errorEl.textContent = error.message === 'Invalid login credentials'
                    ? 'Fel e-post eller l√∂senord'
                    : error.message;
                errorEl.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Logga in';
            }
        }

        async function showDashboard() {
            document.getElementById('login-form').classList.add('hide');
            document.getElementById('dashboard').classList.add('show');

            const email = currentUser.email;
            document.getElementById('user-email-display').textContent = email;
            document.getElementById('user-avatar').textContent = getInitials(email);

            await loadCompanyData();
            await loadAllEvents();
        }

        async function handleLogout() {
            await sb.auth.signOut();
            currentUser = null;
            document.getElementById('dashboard').classList.remove('show');
            document.getElementById('login-form').classList.remove('hide');
        }

        function getInitials(email) {
            const parts = email.split('@')[0].split('.');
            return parts.length >= 2
                ? (parts[0][0] + parts[1][0]).toUpperCase()
                : email.substring(0, 2).toUpperCase();
        }

        // =========================================================================
        // DATA LOADING
        // =========================================================================
        async function loadCompanyData() {
            const { data } = await sb
                .from('loop_table')
                .select('orgnr, company_name, sector, turnover_2024_sek, website')
                .limit(1500);

            companyData = {};
            (data || []).forEach(c => {
                if (c.orgnr) {
                    companyData[c.orgnr] = {
                        name: c.company_name,
                        sector: c.sector,
                        turnover: c.turnover_2024_sek,
                        website: c.website
                    };
                }
            });
        }

        async function loadAllEvents() {
            // Ladda POIT-h√§ndelser
            await loadPoitEvents();

            // Ladda nyheter fr√•n RSS + pressrum
            await loadNewsEvents();

            // Kombinera och sortera
            combineAndRenderEvents();
        }

        async function loadPoitEvents() {
            const { data, error } = await sb
                .from('loop_poit_events')
                .select('*')
                .order('announcement_date', { ascending: false })
                .limit(100);

            if (error) {
                console.error('Error loading POIT events:', error);
                return;
            }

            poitEvents = (data || []).map(e => ({
                id: `poit-${e.id}`,
                type: 'poit',
                category: e.category || 'Ok√§nd',
                title: e.title || e.content,
                content: e.content,
                date: e.announcement_date,
                timestamp: new Date(e.announcement_date).getTime(),
                orgnr: e.orgnr,
                companyName: e.matched_company_name || getCompanyName(e.orgnr) || 'Ok√§nt f√∂retag',
                source: 'Bolagsverket',
                originalEvent: e
            }));
        }

        async function loadNewsEvents() {
            // H√§mta nyheter fr√•n RSS-fl√∂den
            const rssPromises = RSS_FEEDS.map(feed => fetchRSSFeed(feed));
            const rssResults = await Promise.allSettled(rssPromises);

            newsItems = [];
            rssResults.forEach((result, i) => {
                if (result.status === 'fulfilled' && result.value) {
                    result.value.forEach(item => {
                        newsItems.push({
                            id: `news-${item.guid || item.link}`,
                            type: 'news',
                            category: 'Nyhet',
                            title: item.title,
                            date: item.pubDate,
                            timestamp: new Date(item.pubDate).getTime(),
                            orgnr: matchCompanyToNews(item),
                            companyName: item.matchedCompany || RSS_FEEDS[i].name,
                            source: RSS_FEEDS[i].name,
                            link: item.link
                        });
                    });
                }
            });

            // H√§mta pressmeddelanden
            await loadPressReleases();
        }

        async function fetchRSSFeed(feed) {
            try {
                const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}&api_key=bnfk5nmimynubkjxqgdrfwetavgjt6hbkgvnbmsu&count=20`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                return data.status === 'ok' ? data.items : [];
            } catch (e) {
                console.error(`RSS fetch error for ${feed.name}:`, e);
                return [];
            }
        }

        async function loadPressReleases() {
            const { data } = await sb
                .from('company_pressrooms')
                .select('orgnr, company_name, pressroom_url')
                .not('pressroom_url', 'is', null)
                .limit(50);

            // I en riktig implementation skulle vi h√§mta senaste pressmeddelanden
            // F√∂r nu, skippar vi denna del f√∂r att h√•lla det enkelt
        }

        function matchCompanyToNews(item) {
            const title = (item.title || '').toLowerCase();
            for (const orgnr in companyData) {
                const name = (companyData[orgnr].name || '').toLowerCase();
                if (name.length > 3 && title.includes(name)) {
                    item.matchedCompany = companyData[orgnr].name;
                    return orgnr;
                }
            }
            return null;
        }

        function getCompanyName(orgnr) {
            return companyData[orgnr]?.name || null;
        }

        // =========================================================================
        // COMBINE & GROUP EVENTS
        // =========================================================================
        function combineAndRenderEvents() {
            // Kombinera alla events
            allEvents = [...poitEvents, ...newsItems].sort((a, b) => b.timestamp - a.timestamp);

            // Uppdatera r√§knare
            updateCounts();

            // Applicera filter och rendera
            applyFilter(currentFilter);
        }

        function updateCounts() {
            const counts = {
                all: allEvents.length,
                poit: poitEvents.length,
                news: newsItems.filter(n => n.type === 'news').length,
                press: newsItems.filter(n => n.type === 'press').length
            };

            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-poit').textContent = counts.poit;
            document.getElementById('count-news').textContent = counts.news;
            document.getElementById('count-press').textContent = counts.press;
        }

        function applyFilter(filter) {
            currentFilter = filter;

            // Uppdatera aktiv chip
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });

            // Filtrera events
            if (filter === 'all') {
                filteredEvents = [...allEvents];
            } else if (filter === 'poit') {
                filteredEvents = allEvents.filter(e => e.type === 'poit');
            } else if (filter === 'news') {
                filteredEvents = allEvents.filter(e => e.type === 'news');
            } else if (filter === 'press') {
                filteredEvents = allEvents.filter(e => e.type === 'press');
            }

            renderFeed();
        }

        // =========================================================================
        // GROUPING - Konsolidera h√§ndelser per f√∂retag och dag
        // =========================================================================
        function groupEventsByCompanyAndDay(events) {
            const groups = {};

            events.forEach(e => {
                const dateKey = e.date ? e.date.split('T')[0] : 'unknown';
                const companyKey = e.orgnr || e.companyName || 'unknown';
                const groupKey = `${companyKey}_${dateKey}`;

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        key: groupKey,
                        companyName: e.companyName,
                        orgnr: e.orgnr,
                        date: dateKey,
                        latestTimestamp: e.timestamp,
                        events: []
                    };
                }

                groups[groupKey].events.push(e);
                if (e.timestamp > groups[groupKey].latestTimestamp) {
                    groups[groupKey].latestTimestamp = e.timestamp;
                }
            });

            // Sortera grupper efter senaste h√§ndelse
            return Object.values(groups).sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        }

        // =========================================================================
        // RENDERING
        // =========================================================================
        function renderFeed() {
            const container = document.getElementById('feed-container');

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Inga h√§ndelser</h3>
                        <p>Nya h√§ndelser visas h√§r i realtid</p>
                    </div>
                `;
                return;
            }

            // Gruppera events
            const groups = groupEventsByCompanyAndDay(filteredEvents);

            container.innerHTML = groups.map(group => {
                if (group.events.length === 1) {
                    // Enskild h√§ndelse
                    return renderSingleEvent(group.events[0]);
                } else {
                    // Grupperad vy
                    return renderGroupedCard(group);
                }
            }).join('');
        }

        function renderSingleEvent(e) {
            const typeClass = getTypeClass(e);
            const initial = (e.companyName || 'X').charAt(0).toUpperCase();

            return `
                <div class="single-event-card" onclick="showEventModal('${e.id}')">
                    <div class="company-logo">${initial}</div>
                    <div class="event-content">
                        <div class="company-name">${escapeHtml(e.companyName)}</div>
                        <div class="event-title">${escapeHtml(e.title || '')}</div>
                        <div class="event-meta">
                            <span class="event-tag ${typeClass}">${escapeHtml(e.category)}</span>
                            <span>${formatDate(e.date)}</span>
                            <span>‚Ä¢ ${e.source}</span>
                        </div>
                    </div>
                    ${e.link ? `<a href="${e.link}" target="_blank" class="event-link" onclick="event.stopPropagation()">L√§s ‚Üó</a>` : ''}
                </div>
            `;
        }

        function renderGroupedCard(group) {
            const initial = (group.companyName || 'X').charAt(0).toUpperCase();
            const eventCount = group.events.length;

            return `
                <div class="company-card">
                    <div class="company-header" onclick="showCompanyModal('${group.orgnr || ''}', '${escapeHtml(group.companyName)}')">
                        <div class="company-logo">${initial}</div>
                        <div class="company-info">
                            <div class="company-name">${escapeHtml(group.companyName)}</div>
                            <div class="company-meta">
                                ${group.orgnr ? `<span class="company-orgnr">${group.orgnr}</span>` : ''}
                            </div>
                        </div>
                        <span class="company-time">${formatDate(group.date)}</span>
                        <span class="event-count-badge">${eventCount} h√§ndelser</span>
                    </div>
                    <div class="event-list">
                        ${group.events.map(e => renderEventItem(e)).join('')}
                    </div>
                </div>
            `;
        }

        function renderEventItem(e) {
            const typeClass = getTypeClass(e);

            return `
                <div class="event-item" onclick="showEventModal('${e.id}')">
                    <div class="event-type-indicator ${typeClass}"></div>
                    <div class="event-content">
                        <div class="event-title">${escapeHtml(truncate(e.title || '', 100))}</div>
                        <div class="event-meta">
                            <span class="event-tag ${typeClass}">${escapeHtml(e.category)}</span>
                            <span>${formatTime(e.date)}</span>
                            <span>‚Ä¢ ${e.source}</span>
                        </div>
                    </div>
                    ${e.link ? `<a href="${e.link}" target="_blank" class="event-link" onclick="event.stopPropagation()">‚Üó</a>` : ''}
                </div>
            `;
        }

        function getTypeClass(e) {
            if (e.type === 'news') return 'news';
            if (e.type === 'press') return 'press';

            const cat = (e.category || '').toLowerCase();
            if (cat.includes('konkurs')) return 'konkurs';
            if (cat.includes('kallelse')) return 'kallelse';
            if (cat.includes('likvidation')) return 'likvidation';
            if (cat.includes('skuld')) return 'skuld';
            if (cat.includes('styrelse')) return 'styrelse';
            if (cat.includes('fusion')) return 'fusion';
            return 'default';
        }

        // =========================================================================
        // MODAL
        // =========================================================================
        function showEventModal(eventId) {
            const event = allEvents.find(e => e.id === eventId);
            if (!event) return;

            document.getElementById('modal-title').textContent = event.companyName;

            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <div class="detail-section-title">H√§ndelse</div>
                    <p style="margin-bottom: 1rem;">${escapeHtml(event.title || event.content || '')}</p>
                    <div class="detail-row">
                        <span class="detail-label">Typ</span>
                        <span class="detail-value"><span class="event-tag ${getTypeClass(event)}">${escapeHtml(event.category)}</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Datum</span>
                        <span class="detail-value">${formatDate(event.date)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">K√§lla</span>
                        <span class="detail-value">${escapeHtml(event.source)}</span>
                    </div>
                    ${event.orgnr ? `
                    <div class="detail-row">
                        <span class="detail-label">Org.nr</span>
                        <span class="detail-value">${event.orgnr}</span>
                    </div>
                    ` : ''}
                </div>
                ${event.link ? `
                <div class="detail-section">
                    <a href="${event.link}" target="_blank" class="btn btn-primary" style="width: 100%;">
                        √ñppna k√§lla ‚Üó
                    </a>
                </div>
                ` : ''}
            `;

            document.getElementById('modal-overlay').classList.add('show');
        }

        function showCompanyModal(orgnr, companyName) {
            const company = orgnr ? companyData[orgnr] : null;
            const companyEvents = allEvents.filter(e => e.orgnr === orgnr || e.companyName === companyName);

            document.getElementById('modal-title').textContent = companyName;

            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <div class="detail-section-title">F√∂retagsinformation</div>
                    ${orgnr ? `
                    <div class="detail-row">
                        <span class="detail-label">Org.nr</span>
                        <span class="detail-value">${orgnr}</span>
                    </div>
                    ` : ''}
                    ${company?.sector ? `
                    <div class="detail-row">
                        <span class="detail-label">Sektor</span>
                        <span class="detail-value">${escapeHtml(company.sector)}</span>
                    </div>
                    ` : ''}
                    ${company?.turnover ? `
                    <div class="detail-row">
                        <span class="detail-label">Oms√§ttning</span>
                        <span class="detail-value">${formatNumber(company.turnover)} kr</span>
                    </div>
                    ` : ''}
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">H√§ndelser (${companyEvents.length})</div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${companyEvents.map(e => `
                            <div class="event-item" style="padding: 0.5rem 0;">
                                <div class="event-type-indicator ${getTypeClass(e)}"></div>
                                <div class="event-content">
                                    <div class="event-title">${escapeHtml(truncate(e.title || '', 80))}</div>
                                    <div class="event-meta">
                                        <span class="event-tag ${getTypeClass(e)}">${escapeHtml(e.category)}</span>
                                        <span>${formatDate(e.date)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('modal-footer').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">St√§ng</button>
                ${orgnr ? `<a href="verktyg/foretagsbevakning/?orgnr=${orgnr}" class="btn btn-primary">Visa f√∂retag</a>` : ''}
            `;

            document.getElementById('modal-overlay').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
        }

        // =========================================================================
        // SIDEBAR PANEL HANDLING
        // =========================================================================
        function togglePanel(panelId) {
            const panel = document.getElementById(`panel-${panelId}`);
            const isOpen = panel?.classList.contains('open');

            // St√§ng alla paneler
            document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('open'));
            document.querySelectorAll('.sidebar-icon').forEach(i => i.classList.remove('active'));

            // Om panelen inte var √∂ppen, √∂ppna den
            if (!isOpen && panel) {
                panel.classList.add('open');
                document.querySelector(`[data-panel="${panelId}"]`)?.classList.add('active');
            } else {
                // Aktivera feed-ikonen som default
                document.querySelector('[data-panel="feed"]')?.classList.add('active');
            }
        }

        // =========================================================================
        // UTILITIES
        // =========================================================================
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const now = new Date();

            if (date.toDateString() === now.toDateString()) return 'Idag';

            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) return 'Ig√•r';

            return date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
        }

        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        }

        function formatNumber(num) {
            if (!num) return '-';
            return new Intl.NumberFormat('sv-SE').format(num);
        }

        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // =========================================================================
        // EVENT LISTENERS
        // =========================================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            document.getElementById('login-form-element').addEventListener('submit', handleLogin);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => applyFilter(chip.dataset.filter));
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', loadAllEvents);

            // Sidebar icons
            document.querySelectorAll('.sidebar-icon[data-panel]').forEach(icon => {
                icon.addEventListener('click', () => {
                    const panel = icon.dataset.panel;
                    if (panel === 'feed') {
                        // St√§ng alla paneler, visa bara feed
                        document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('open'));
                        document.querySelectorAll('.sidebar-icon').forEach(i => i.classList.remove('active'));
                        icon.classList.add('active');
                    } else {
                        togglePanel(panel);
                    }
                });
            });

            // Modal close
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal-overlay')) closeModal();
            });

            // Initialize Supabase
            initSupabase();

            // Auto-refresh every 5 minutes
            setInterval(loadAllEvents, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
