<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bevakningsverktyget - Loop Impact</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="assets/css/variables.css">
    <link rel="stylesheet" href="assets/css/reset.css">
    <style>
        /* ========================================================================
           MINIMAL DASHBOARD DESIGN
           ======================================================================== */

        :root {
            --nav-height: 64px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50, #f8fafc);
            color: var(--dark, #1a1a2e);
            line-height: 1.5;
        }

        /* ========================================================================
           LOGIN PAGE
           ======================================================================== */
        .login-page {
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr 480px;
        }

        .login-hero {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4rem;
        }

        .login-hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1.1;
            margin-bottom: 1.5rem;
        }

        .login-hero p {
            font-size: 1.125rem;
            opacity: 0.8;
            max-width: 400px;
        }

        .login-form-container {
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4rem;
        }

        .login-logo {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #64748b;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #94a3b8;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            gap: 0.5rem;
        }

        .btn-primary {
            width: 100%;
            background: #1a1a2e;
            color: white;
        }

        .btn-primary:hover {
            background: #16213e;
        }

        .btn-ghost {
            background: transparent;
            color: #64748b;
        }

        .btn-ghost:hover {
            background: #f1f5f9;
            color: #1a1a2e;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        .alert.show { display: block; }
        .alert-error { background: #fef2f2; color: #dc2626; }
        .alert-success { background: #f0fdf4; color: #16a34a; }

        .login-footer {
            margin-top: 2rem;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .login-page.hide { display: none; }

        @media (max-width: 900px) {
            .login-page { grid-template-columns: 1fr; }
            .login-hero { display: none; }
        }

        /* ========================================================================
           DASHBOARD LAYOUT
           ======================================================================== */
        #dashboard {
            display: none;
            min-height: 100vh;
        }

        #dashboard.show { display: block; }

        /* Navigation */
        .nav {
            height: var(--nav-height);
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            font-weight: 600;
            font-size: 1rem;
            color: #1a1a2e;
            text-decoration: none;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.375rem 0.75rem 0.375rem 0.375rem;
            background: #f8fafc;
            border-radius: 100px;
            font-size: 0.875rem;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #1a1a2e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: flex;
            min-height: calc(100vh - var(--nav-height));
        }

        /* ========================================================================
           ICON SIDEBAR
           ======================================================================== */
        .icon-sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            gap: 0.25rem;
            position: sticky;
            top: var(--nav-height);
            height: calc(100vh - var(--nav-height));
        }

        .sidebar-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 1.25rem;
            color: #64748b;
            position: relative;
            background: transparent;
            border: none;
        }

        .sidebar-icon:hover {
            background: #f1f5f9;
            color: #1a1a2e;
        }

        .sidebar-icon.active {
            background: #1a1a2e;
            color: white;
        }

        .sidebar-icon-tooltip {
            position: absolute;
            left: calc(100% + 12px);
            background: #1a1a2e;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            pointer-events: none;
            z-index: 50;
        }

        .sidebar-icon:hover .sidebar-icon-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-divider {
            width: 32px;
            height: 1px;
            background: #e2e8f0;
            margin: 0.5rem 0;
        }

        .sidebar-spacer {
            flex: 1;
        }

        /* Expanded Sidebar Panel */
        .sidebar-panel {
            position: fixed;
            top: var(--nav-height);
            left: var(--sidebar-width);
            width: calc(var(--sidebar-expanded) - var(--sidebar-width));
            height: calc(100vh - var(--nav-height));
            background: white;
            border-right: 1px solid #e2e8f0;
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 40;
            overflow-y: auto;
            padding: 1rem;
        }

        .sidebar-panel.open {
            transform: translateX(0);
            opacity: 1;
        }

        .panel-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.75rem;
            padding: 0 0.5rem;
        }

        .panel-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 8px;
            text-decoration: none;
            color: #1a1a2e;
            font-size: 0.875rem;
            transition: background 0.15s;
        }

        .panel-link:hover {
            background: #f1f5f9;
        }

        .panel-link-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .panel-link:hover .panel-link-icon {
            background: #e2e8f0;
        }

        /* ========================================================================
           MAIN CONTENT
           ======================================================================== */
        .main-content {
            flex: 1;
            padding: 1.5rem 2rem;
            max-width: 900px;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 100px;
            font-size: 0.8125rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-chip:hover {
            border-color: #94a3b8;
            color: #1a1a2e;
        }

        .filter-chip.active {
            background: #1a1a2e;
            border-color: #1a1a2e;
            color: white;
        }

        .filter-chip .count {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            background: rgba(0,0,0,0.1);
            border-radius: 100px;
        }

        .filter-chip.active .count {
            background: rgba(255,255,255,0.2);
        }

        .filter-spacer { flex: 1; }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.8125rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .refresh-btn:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        /* Feed */
        .feed-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Company Card (Grouped) */
        .company-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: box-shadow 0.15s;
        }

        .company-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .company-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            cursor: pointer;
        }

        .company-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .company-info {
            flex: 1;
            min-width: 0;
        }

        .company-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: #1a1a2e;
            margin-bottom: 0.125rem;
        }

        .company-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
            color: #94a3b8;
        }

        .company-orgnr {
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.75rem;
        }

        .company-time {
            font-size: 0.8125rem;
            color: #94a3b8;
            white-space: nowrap;
        }

        .event-count-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f1f5f9;
            border-radius: 100px;
            font-size: 0.75rem;
            color: #64748b;
        }

        /* Event List */
        .event-list {
            border-top: 1px solid #f1f5f9;
        }

        .event-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f8fafc;
            transition: background 0.1s;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-item:hover {
            background: #fafbfc;
        }

        .event-type-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .event-type-indicator.konkurs { background: #ef4444; }
        .event-type-indicator.kallelse { background: #f59e0b; }
        .event-type-indicator.likvidation { background: #ef4444; }
        .event-type-indicator.skuld { background: #f97316; }
        .event-type-indicator.styrelse { background: #3b82f6; }
        .event-type-indicator.fusion { background: #8b5cf6; }
        .event-type-indicator.news { background: #10b981; }
        .event-type-indicator.press { background: #06b6d4; }
        .event-type-indicator.default { background: #94a3b8; }

        .event-content {
            flex: 1;
            min-width: 0;
        }

        .event-title {
            font-size: 0.875rem;
            color: #1a1a2e;
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .event-tag {
            display: inline-flex;
            padding: 0.125rem 0.375rem;
            background: #f1f5f9;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .event-tag.konkurs { background: #fef2f2; color: #dc2626; }
        .event-tag.kallelse { background: #fffbeb; color: #d97706; }
        .event-tag.likvidation { background: #fef2f2; color: #dc2626; }
        .event-tag.skuld { background: #fff7ed; color: #ea580c; }
        .event-tag.news { background: #ecfdf5; color: #059669; }
        .event-tag.press { background: #ecfeff; color: #0891b2; }

        .event-link {
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.8125rem;
            white-space: nowrap;
        }

        .event-link:hover {
            text-decoration: underline;
        }

        /* Single Event Card */
        .single-event-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            transition: box-shadow 0.15s;
        }

        .single-event-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: #64748b;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        /* Loading */
        .loader {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top-color: #1a1a2e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================================================
           NEW DASHBOARD LAYOUT OVERRIDES
           ======================================================================== */
        .dashboard-shell {
            padding: 2rem 2rem 3rem;
        }

        .dashboard-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .dashboard-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.1;
        }

        .dashboard-subtitle {
            color: #64748b;
            max-width: 520px;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .dashboard-tabs {
            display: flex;
            gap: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .dashboard-tab {
            background: transparent;
            border: none;
            padding: 0.75rem 0.25rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .dashboard-tab.active {
            color: #1a1a2e;
            border-bottom-color: #1a1a2e;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .main-content,
        .panel-block {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .event-time {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .company-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .company-controls input,
        .company-controls select {
            padding: 0.6rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
            min-width: 180px;
        }

        .company-table {
            width: 100%;
            border-collapse: collapse;
        }

        .company-table th,
        .company-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            text-align: left;
            font-size: 0.875rem;
        }

        .company-table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #94a3b8;
        }

        .company-table tbody tr:hover {
            background: #f8fafc;
        }

        .company-name-cell {
            font-weight: 600;
            color: #1a1a2e;
        }

        .company-orgnr {
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .table-actions button {
            border: none;
            background: transparent;
            color: #3b82f6;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 300;
        }

        .drawer-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .settings-drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(420px, 100%);
            background: white;
            border-left: 1px solid #e2e8f0;
            transform: translateX(100%);
            transition: transform 0.25s ease;
            z-index: 310;
            display: flex;
            flex-direction: column;
        }

        .settings-drawer.show {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .drawer-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .drawer-section {
            margin-bottom: 1.5rem;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            padding: 1rem;
        }

        .drawer-section h4 {
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .drawer-section p {
            color: #64748b;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .drawer-field {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .drawer-field input,
        .drawer-field select {
            padding: 0.6rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .drawer-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        @media (max-width: 900px) {
            .dashboard-shell {
                padding: 1rem;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .main-content,
            .panel-block {
                padding: 1rem;
            }
        }

        /* ========================================================================
           MODAL
           ======================================================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 1rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 560px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            color: #64748b;
        }

        .modal-close:hover {
            background: #e2e8f0;
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #1a1a2e;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Detail sections in modal */
        .detail-section {
            margin-bottom: 1.25rem;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            font-size: 0.875rem;
        }

        .detail-label {
            color: #64748b;
        }

        .detail-value {
            color: #1a1a2e;
            font-weight: 500;
        }

        /* ========================================================================
           RESPONSIVE
           ======================================================================== */
        @media (max-width: 768px) {
            .icon-sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                height: auto;
                width: 100%;
                flex-direction: row;
                justify-content: space-around;
                padding: 0.5rem 0;
                border-right: none;
                border-top: 1px solid #e2e8f0;
                z-index: 100;
            }

            .sidebar-divider, .sidebar-spacer {
                display: none;
            }

            .sidebar-icon-tooltip {
                display: none;
            }

            .sidebar-panel {
                display: none;
            }

            .main-content {
                padding: 1rem;
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="login-form">
        <div class="login-hero">
            <h1>Bevaka.<br>Analysera.<br>Publicera.</h1>
            <p>1214 impact-företag under bevakning. Realtidsnotifikationer om bolagshändelser. Nyhetsbevakning för journalister.</p>
        </div>
        <div class="login-form-container">
            <div class="login-logo">Bevakningsverktyget</div>
            <h2 class="login-title">Välkommen tillbaka</h2>
            <p class="login-subtitle">Logga in för att fortsätta</p>
            <div class="alert alert-error" id="error"></div>
            <div class="alert alert-success" id="success"></div>
            <form id="login-form-element">
                <div class="form-group">
                    <label for="email">E-postadress</label>
                    <input type="email" id="email" placeholder="namn@foretag.se" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">Lösenord</label>
                    <input type="password" id="password" placeholder="Ange lösenord" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="submit-btn">Logga in</button>
            </form>
            <div class="login-footer">
                <p>Loop Impact - Bevakningsredaktionen</p>
            </div>
        </div>
    </div>

    <!-- Settings Drawer -->
    <div class="drawer-overlay" id="settings-overlay"></div>
    <aside class="settings-drawer" id="settings-drawer" aria-hidden="true">
        <div class="drawer-header">
            <strong>Inställningar</strong>
            <button class="btn btn-ghost" id="settings-close">Stäng</button>
        </div>
        <div class="drawer-body">
            <div class="drawer-section">
                <h4>Budget</h4>
                <p>Översikt av budget och spend.</p>
                <div class="drawer-field">
                    <label for="budget-daily">Daglig gräns (SEK)</label>
                    <input type="number" id="budget-daily" min="0" step="1">
                </div>
                <div class="drawer-field">
                    <label for="budget-monthly">Månatlig gräns (SEK)</label>
                    <input type="number" id="budget-monthly" min="0" step="1">
                </div>
                <div class="drawer-actions">
                    <button class="btn btn-primary" id="save-budget-btn">Spara budget</button>
                </div>
            </div>

            <div class="drawer-section">
                <h4>SMS-notiser</h4>
                <p>Hantera viktiga larm och telefonnummer.</p>
                <div class="drawer-field">
                    <label for="sms-phone">Mobilnummer</label>
                    <input type="tel" id="sms-phone" placeholder="+46 70 000 00 00">
                </div>
                <div class="drawer-field">
                    <label for="sms-important">Viktiga händelser</label>
                    <select id="sms-important" multiple>
                        <option value="konkurs">Konkursbeslut</option>
                        <option value="likvidation">Likvidation</option>
                        <option value="styrelse">Styrelseförändring</option>
                        <option value="fusion">Fusion/uppköp</option>
                    </select>
                </div>
                <div class="drawer-field">
                    <label for="sms-orgnrs">Bevaka org.nr (komma-separerat)</label>
                    <input type="text" id="sms-orgnrs" placeholder="5566778899, 5599990000">
                </div>
                <div class="drawer-actions">
                    <button class="btn btn-primary" id="save-sms-btn">Spara SMS-inställningar</button>
                </div>
            </div>

            <div class="drawer-section">
                <h4>Budgetlogg</h4>
                <p>Senaste kostnader som påverkar budgeten.</p>
                <div id="budget-log-summary" class="event-meta" style="margin-bottom: 0.75rem;">-</div>
                <div id="budget-log-list" class="event-meta">Laddar budgetlogg...</div>
            </div>

            <div class="drawer-section">
                <h4>SMS-logg & Kostnad</h4>
                <p>Senaste inkommande/utgående SMS och kostnad.</p>
                <div id="sms-billing-summary" class="event-meta" style="margin-bottom: 0.75rem;">-</div>
                <div id="sms-log-list" class="event-meta">Laddar SMS-logg...</div>
            </div>
        </div>
    </aside>

    <!-- Dashboard -->
    <div id="dashboard">
        <nav class="nav">
            <a href="./" class="nav-brand">Bevakningsverktyget</a>
            <div class="nav-right">
                <div class="user-pill">
                    <div class="user-avatar" id="user-avatar">IS</div>
                    <span id="user-email-display"></span>
                </div>
            </div>
        </nav>

        <div class="dashboard-shell">
            <div class="dashboard-wrapper">
                <section class="dashboard-header">
                    <div>
                        <h1 class="dashboard-title">Realtidsbevakning</h1>
                        <p class="dashboard-subtitle">Samlad vy av nyheter, pressmeddelanden och bolagshändelser för Loop Impact-portföljen.</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="settings-open">Inställningar</button>
                        <button class="btn btn-ghost" id="logout-btn">Logga ut</button>
                    </div>
                </section>

                <div class="dashboard-tabs">
                    <button class="dashboard-tab active" data-tab="feed">Flöde</button>
                    <button class="dashboard-tab" data-tab="companies">Företag</button>
                </div>

                <section class="tab-panel active" id="tab-feed">
                    <div class="main-content">
                        <div class="panel-header">
                            <div class="panel-title">Samlat flöde</div>
                            <button class="refresh-btn" id="refresh-btn">↻ Uppdatera</button>
                        </div>
                        <div class="filter-bar">
                            <button class="filter-chip active" data-filter="all">
                                Alla <span class="count" id="count-all">0</span>
                            </button>
                            <button class="filter-chip" data-filter="poit">
                                Bolagshändelser <span class="count" id="count-poit">0</span>
                            </button>
                            <button class="filter-chip" data-filter="news">
                                Nyheter <span class="count" id="count-news">0</span>
                            </button>
                            <button class="filter-chip" data-filter="press">
                                Press <span class="count" id="count-press">0</span>
                            </button>
                        </div>

                        <div class="feed-container" id="feed-container">
                            <div class="empty-state">
                                <div class="loader"></div>
                                <p>Laddar händelser...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" id="tab-companies">
                    <div class="panel-block">
                        <div class="panel-header">
                            <div class="panel-title">Företagsöversikt</div>
                            <span id="company-count-label" class="event-meta">- företag</span>
                        </div>
                        <div class="company-controls">
                            <input type="text" id="company-search-input" placeholder="Sök företag eller orgnr...">
                            <select id="company-sector-filter">
                                <option value="">Alla sektorer</option>
                            </select>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="company-table">
                                <thead>
                                    <tr>
                                        <th>Företag</th>
                                        <th>Sektor</th>
                                        <th>Omsättning</th>
                                        <th>Org.nr</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="company-table-body">
                                    <tr>
                                        <td colspan="5" class="empty-state">Laddar företag...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Händelsedetaljer</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-secondary" id="modal-close-btn">Stäng</button>
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script>
        // =========================================================================
        // STATE
        // =========================================================================
        let sb = null;
        let currentUser = null;
        let allEvents = [];          // Combined events (POIT + News)
        let filteredEvents = [];
        let currentFilter = 'all';
        let companyData = {};        // orgnr -> company info
        let allCompanies = [];
        let filteredCompanies = [];
        let newsItems = [];
        let poitEvents = [];
        let companySearchQuery = '';
        let companySectorFilter = '';
        const LOGO_BUCKET_NAME = 'company-logos';
        const logoCache = {};

        function cleanOrgNr(orgnr) {
            if (!orgnr) return '';
            return orgnr.replace(/\D/g, '');
        }

        function getCompanyLogoUrl(orgnr) {
            if (!orgnr || !sb) return null;
            const clean = cleanOrgNr(orgnr);
            if (!clean) return null;

            if (logoCache[clean] === undefined) {
                try {
                    const { data } = sb.storage.from(LOGO_BUCKET_NAME).getPublicUrl(`${clean}.png`);
                    logoCache[clean] = data?.publicUrl || null;
                } catch (error) {
                    console.error('Logo fetch failed', error);
                    logoCache[clean] = null;
                }
            }

            return logoCache[clean];
        }

        function renderLogoElement(logoUrl, label) {
            const text = (label || 'Företag').split(' ').filter(Boolean);
            const initials = (text.length >= 2 ? text.slice(0, 2) : text).map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2) || 'FB';

            if (logoUrl) {
                const safeUrl = escapeHtml(logoUrl);
                return `<div class="company-logo"><img src="${safeUrl}" alt="${escapeHtml(label || 'Företag')} logo" loading="lazy" onerror="this.remove();"></div>`;
            }

            return `<div class="company-logo">${escapeHtml(initials)}</div>`;
        }

        // RSS feeds (samma som nyhetsflöde)
        const RSS_FEEDS = [
            { name: 'Breakit', url: 'https://www.breakit.se/feed/artiklar', type: 'news' },
            { name: 'DI Digital', url: 'https://www.di.se/rss/nyheter/', type: 'news' },
            { name: 'Ny Teknik', url: 'https://www.nyteknik.se/feed', type: 'news' }
        ];

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        async function initSupabase() {
            try {
                sb = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                const { data: { session } } = await sb.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await showDashboard();
                }
            } catch (error) {
                console.error('Supabase init error:', error);
            }
        }

        // =========================================================================
        // AUTHENTICATION
        // =========================================================================
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitBtn = document.getElementById('submit-btn');
            const errorEl = document.getElementById('error');
            const successEl = document.getElementById('success');

            errorEl.classList.remove('show');
            successEl.classList.remove('show');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Loggar in...';

            try {
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = data.user;
                successEl.textContent = 'Inloggning lyckades!';
                successEl.classList.add('show');
                setTimeout(() => showDashboard(), 300);
            } catch (error) {
                errorEl.textContent = error.message === 'Invalid login credentials'
                    ? 'Fel e-post eller lösenord'
                    : error.message;
                errorEl.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Logga in';
            }
        }

        async function showDashboard() {
            document.getElementById('login-form').classList.add('hide');
            document.getElementById('dashboard').classList.add('show');

            const email = currentUser.email;
            document.getElementById('user-email-display').textContent = email;
            document.getElementById('user-avatar').textContent = getInitials(email);

            await loadCompanyData();
            await loadAllEvents();
            await loadSettings();
        }

        async function handleLogout() {
            await sb.auth.signOut();
            currentUser = null;
            document.getElementById('dashboard').classList.remove('show');
            document.getElementById('login-form').classList.remove('hide');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === `tab-${tabId}`);
            });
        }

        function openSettingsDrawer() {
            document.getElementById('settings-drawer').classList.add('show');
            document.getElementById('settings-overlay').classList.add('show');
            document.getElementById('settings-drawer').setAttribute('aria-hidden', 'false');
        }

        function closeSettingsDrawer() {
            document.getElementById('settings-drawer').classList.remove('show');
            document.getElementById('settings-overlay').classList.remove('show');
            document.getElementById('settings-drawer').setAttribute('aria-hidden', 'true');
        }

        function getInitials(email) {
            const parts = email.split('@')[0].split('.');
            return parts.length >= 2
                ? (parts[0][0] + parts[1][0]).toUpperCase()
                : email.substring(0, 2).toUpperCase();
        }

        // =========================================================================
        // DATA LOADING
        // =========================================================================
        async function loadCompanyData() {
            const { data, error } = await sb
                .from('loop_table')
                .select('orgnr, company_name, sector, turnover_2024_sek, website, city, ceo_name, chairman_name')
                .limit(1500);

            if (error) {
                console.error('Error loading company data:', error);
            }
            console.log(`Loaded ${data?.length || 0} companies from loop_table`);

            allCompanies = data || [];
            companyData = {};
            allCompanies.forEach(c => {
                if (c.orgnr) {
                    const logoUrl = getCompanyLogoUrl(c.orgnr);
                    companyData[c.orgnr] = {
                        name: c.company_name,
                        sector: c.sector,
                        turnover: c.turnover_2024_sek,
                        website: c.website,
                        city: c.city,
                        ceo: c.ceo_name,
                        chairman: c.chairman_name,
                        logoUrl
                    };
                    c.logoUrl = logoUrl;
                }
            });

            initCompanyFilters();
            applyCompanyFilters();
        }

        async function loadAllEvents() {
            // Ladda POIT-händelser
            await loadPoitEvents();

            // Ladda nyheter från RSS + pressrum
            await loadNewsEvents();

            // Kombinera och sortera
            combineAndRenderEvents();
        }

        async function loadPoitEvents() {
            const { data, error } = await sb
                .from('loop_poit_events')
                .select('*')
                .order('announcement_date', { ascending: false })
                .limit(100);

            if (error) {
                console.error('Error loading POIT events:', error);
                return;
            }

            // Filtrera mot bevakade bolag
            const trackedOrgNrs = new Set(allCompanies.map(c => c.orgnr).filter(Boolean));

            poitEvents = (data || [])
                .filter(e => {
                    if (!e.orgnr) return false;
                    const clean = e.orgnr.replace(/-/g, '');
                    return trackedOrgNrs.has(clean) || trackedOrgNrs.has(e.orgnr);
                })
                .map(e => ({
                    id: `poit-${e.id}`,
                    type: 'poit',
                    category: e.category || 'Okänd',
                    title: e.title || e.content,
                    content: e.content,
                    date: e.announcement_date,
                    timestamp: new Date(e.announcement_date).getTime(),
                    orgnr: e.orgnr,
                    companyName: e.matched_company_name || getCompanyName(e.orgnr) || 'Okänt företag',
                    logoUrl: getCompanyLogoUrl(e.orgnr),
                    source: 'Bolagsverket',
                    originalEvent: e
                }));

            console.log(`POIT: ${poitEvents.length} av ${data?.length || 0} matchade bevakade bolag`);
        }

        async function loadNewsEvents() {
            // Hämta nyheter från RSS-flöden
            const rssPromises = RSS_FEEDS.map(feed => fetchRSSFeed(feed));
            const rssResults = await Promise.allSettled(rssPromises);

            newsItems = [];
            const seenLinks = new Set();
            rssResults.forEach((result, i) => {
                if (result.status === 'fulfilled' && result.value) {
                    result.value.forEach(item => {
                        const linkKey = item.link || item.guid;
                        if (linkKey && seenLinks.has(linkKey)) return;
                        if (linkKey) seenLinks.add(linkKey);
                        const matchedOrg = matchCompanyToNews(item);
                        newsItems.push({
                            id: `news-${item.guid || item.link}`,
                            type: 'news',
                            category: 'Nyhet',
                            title: item.title,
                            date: item.pubDate,
                            timestamp: new Date(item.pubDate).getTime(),
                            orgnr: matchedOrg,
                            logoUrl: matchedOrg ? getCompanyLogoUrl(matchedOrg) : null,
                            companyName: item.matchedCompany || RSS_FEEDS[i].name,
                            source: RSS_FEEDS[i].name,
                            link: item.link
                        });
                    });
                }
            });

            // Hämta pressmeddelanden
            await loadPressReleases();
        }

        async function fetchRSSFeed(feed) {
            try {
                const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}&api_key=bnfk5nmimynubkjxqgdrfwetavgjt6hbkgvnbmsu&count=20`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                return data.status === 'ok' ? data.items : [];
            } catch (e) {
                console.error(`RSS fetch error for ${feed.name}:`, e);
                return [];
            }
        }

        async function loadPressReleases() {
            const { data } = await sb
                .from('company_pressrooms')
                .select('orgnr, company_name, rss_feed_url')
                .not('rss_feed_url', 'is', null)
                .limit(30);

            if (!data || data.length === 0) return;

            const pressPromises = data.map(async (pressroom) => {
                const items = await fetchRSSFeed({
                    name: pressroom.company_name || 'Pressrum',
                    url: pressroom.rss_feed_url,
                    type: 'press'
                });

                items.forEach(item => {
                    newsItems.push({
                        id: `press-${item.guid || item.link}`,
                        type: 'press',
                        category: 'Press',
                        title: item.title,
                        date: item.pubDate,
                        timestamp: new Date(item.pubDate).getTime(),
                        orgnr: pressroom.orgnr,
                        logoUrl: getCompanyLogoUrl(pressroom.orgnr),
                        companyName: pressroom.company_name || 'Pressrum',
                        source: pressroom.company_name || 'Pressrum',
                        link: item.link
                    });
                });
            });

            await Promise.allSettled(pressPromises);
        }

        function matchCompanyToNews(item) {
            const title = (item.title || '').toLowerCase();
            for (const orgnr in companyData) {
                const name = (companyData[orgnr].name || '').toLowerCase();
                if (name.length > 3 && title.includes(name)) {
                    item.matchedCompany = companyData[orgnr].name;
                    item.matchedOrgNr = orgnr;
                    return orgnr;
                }
            }
            return null;
        }

        function getCompanyName(orgnr) {
            return companyData[orgnr]?.name || null;
        }

        // =========================================================================
        // COMPANY LIST
        // =========================================================================
        function initCompanyFilters() {
            const sectorSelect = document.getElementById('company-sector-filter');
            if (!sectorSelect) return;

            const sectors = Array.from(new Set(allCompanies.map(c => c.sector).filter(Boolean))).sort();
            sectorSelect.innerHTML = ['<option value="">Alla sektorer</option>']
                .concat(sectors.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`))
                .join('');

            document.getElementById('company-count-label').textContent = `${allCompanies.length} företag`;
        }

        function applyCompanyFilters() {
            const query = companySearchQuery.toLowerCase();
            filteredCompanies = allCompanies.filter(c => {
                const matchesQuery = !query ||
                    (c.company_name || '').toLowerCase().includes(query) ||
                    (c.orgnr || '').toLowerCase().includes(query);
                const matchesSector = !companySectorFilter || c.sector === companySectorFilter;
                return matchesQuery && matchesSector;
            });
            renderCompanyTable();
        }

        function renderCompanyTable() {
            const tbody = document.getElementById('company-table-body');
            if (!tbody) return;

            if (!filteredCompanies.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Inga företag matchar filtret.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredCompanies.slice(0, 200).map(c => {
                const logoUrl = c.logoUrl || companyData[c.orgnr]?.logoUrl || getCompanyLogoUrl(c.orgnr);
                const meta = c.city || c.ceo || c.chairman || c.sector || '';
                return `
                <tr>
                    <td>
                        <div class="company-cell">
                            ${renderLogoElement(logoUrl, c.company_name)}
                            <div class="company-cell-info">
                                <span class="company-name">${escapeHtml(c.company_name || '-')}</span>
                                <span class="company-cell-meta">${escapeHtml(meta)}</span>
                            </div>
                        </div>
                    </td>
                    <td>${escapeHtml(c.sector || '-')}</td>
                    <td>${c.turnover_2024_sek ? formatNumber(c.turnover_2024_sek) + ' kr' : '-'}</td>
                    <td>${escapeHtml(c.orgnr || '-')}</td>
                    <td class="table-actions">
                        <button onclick='showCompanyModal("${c.orgnr || ''}", ${JSON.stringify(c.company_name || '')})'>Öppna</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // =========================================================================
        // SETTINGS
        // =========================================================================
        async function loadSettings() {
            if (!currentUser) return;

            await Promise.all([
                loadBudgetSettings(),
                loadSmsSettings(),
                loadSmsLogs(),
                loadSmsBilling(),
                loadBudgetLogOverview()
            ]);
        }

        async function loadBudgetSettings() {
            try {
                const { data } = await sb
                    .from('user_budget_limits')
                    .select('daily_limit, monthly_limit')
                    .eq('user_id', currentUser.id)
                    .single();

                if (data) {
                    document.getElementById('budget-daily').value = data.daily_limit ?? '';
                    document.getElementById('budget-monthly').value = data.monthly_limit ?? '';
                }
            } catch (error) {
                console.error('Budget settings load failed:', error);
            }
        }

        async function saveBudgetSettings() {
            if (!currentUser) return;
            const daily = parseFloat(document.getElementById('budget-daily').value || '0');
            const monthly = parseFloat(document.getElementById('budget-monthly').value || '0');

            try {
                await sb.from('user_budget_limits')
                    .upsert({
                        user_id: currentUser.id,
                        daily_limit: daily,
                        monthly_limit: monthly
                    });
            } catch (error) {
                console.error('Budget settings save failed:', error);
            }
        }

        async function loadSmsSettings() {
            try {
                const { data } = await sb
                    .from('sms_preferences')
                    .select('phone_number, important_events, important_orgnrs')
                    .eq('user_id', currentUser.id)
                    .single();

                if (data) {
                    document.getElementById('sms-phone').value = data.phone_number || '';
                    const select = document.getElementById('sms-important');
                    if (Array.isArray(data.important_events)) {
                        Array.from(select.options).forEach(opt => {
                            opt.selected = data.important_events.includes(opt.value);
                        });
                    }
                    if (Array.isArray(data.important_orgnrs)) {
                        document.getElementById('sms-orgnrs').value = data.important_orgnrs.join(', ');
                    }
                }
            } catch (error) {
                console.error('SMS settings load failed:', error);
            }
        }

        async function saveSmsSettings() {
            if (!currentUser) return;
            const phone = document.getElementById('sms-phone').value.trim();
            const select = document.getElementById('sms-important');
            const importantEvents = Array.from(select.selectedOptions).map(opt => opt.value);
            const orgnrInput = document.getElementById('sms-orgnrs').value || '';
            const importantOrgnrs = orgnrInput
                .split(',')
                .map(v => v.trim())
                .filter(Boolean);

            try {
                await sb.from('sms_preferences')
                    .upsert({
                        user_id: currentUser.id,
                        phone_number: phone,
                        important_events: importantEvents,
                        important_orgnrs: importantOrgnrs
                    });
            } catch (error) {
                console.error('SMS settings save failed:', error);
            }
        }

        async function loadSmsLogs() {
            const container = document.getElementById('sms-log-list');
            if (!container) return;

            try {
                const { data } = await sb
                    .from('sms_logs')
                    .select('to_phone, from_phone, message, status, sent_at, cost_sek')
                    .order('sent_at', { ascending: false })
                    .limit(5);

                if (!data || data.length === 0) {
                    container.textContent = 'Inga SMS-loggar ännu.';
                    return;
                }

                container.innerHTML = data.map(log => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${escapeHtml(log.from_phone || log.to_phone || '')}</strong>
                            <div class="event-time">${formatDate(log.sent_at)} ${formatTime(log.sent_at)}</div>
                            <div>${escapeHtml(truncate(log.message || '', 80))}</div>
                        </div>
                        <div class="event-time">${log.cost_sek ? log.cost_sek + ' kr' : ''}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('SMS log load failed:', error);
                container.textContent = 'Kunde inte ladda SMS-logg.';
            }
        }

        async function loadSmsBilling() {
            const summary = document.getElementById('sms-billing-summary');
            if (!summary) return;

            try {
                const { data } = await sb
                    .from('budget_logs')
                    .select('cost_sek, created_at')
                    .eq('service', 'twilio')
                    .order('created_at', { ascending: false })
                    .limit(100);

                const total = (data || []).reduce((sum, row) => sum + (row.cost_sek || 0), 0);
                summary.textContent = `Twilio kostnad (senaste 100): ${total.toFixed(2)} kr`;
            } catch (error) {
                console.error('SMS billing load failed:', error);
                summary.textContent = 'Kunde inte ladda kostnad.';
            }
        }

        async function loadBudgetLogOverview() {
            const summary = document.getElementById('budget-log-summary');
            const list = document.getElementById('budget-log-list');
            if (!summary || !list) return;

            try {
                const { data, error } = await sb
                    .from('budget_logs')
                    .select('service,operation,cost_sek,created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                if (!data || data.length === 0) {
                    summary.textContent = 'Inga budgetnoteringar ännu.';
                    list.textContent = '';
                    return;
                }

                const total = data.reduce((sum, row) => sum + (row.cost_sek || 0), 0);
                summary.textContent = `Budgetkostnad (senaste ${data.length}): ${total.toFixed(2)} kr`;
                list.innerHTML = data.map(row => `
                    <div class="log-entry">
                        <div>
                            <strong>${escapeHtml(row.service || 'Okänt')}</strong> ${escapeHtml(row.operation || '')}
                            <div class="event-time" style="font-size: var(--font-size-xxs);">
                                ${formatDate(row.created_at)} ${formatTime(row.created_at)}
                            </div>
                        </div>
                        <div class="event-time">${row.cost_sek ? row.cost_sek.toFixed(2) + ' kr' : '-'}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Budget log load failed:', error);
                summary.textContent = 'Kunde inte ladda budgetlogg.';
                list.textContent = '';
            }
        }

        async function loadCompanyDocumentsInline(orgnr) {
            const container = document.getElementById('company-documents-inline');
            if (!container) return;

            try {
                const cleanOrgnr = (orgnr || '').replace(/-/g, '');
                const { data, error } = await sb
                    .from('company_documents')
                    .select('title, document_type, source_url, created_at')
                    .eq('org_nr', cleanOrgnr)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.textContent = 'Inga dokument ännu.';
                    return;
                }

                container.innerHTML = data.map(doc => `
                    <div style="margin-bottom: 0.5rem;">
                        ${doc.source_url ? `<a href="${doc.source_url}" target="_blank" class="event-link">${escapeHtml(doc.title || doc.document_type || 'Dokument')}</a>` : `<span>${escapeHtml(doc.title || doc.document_type || 'Dokument')}</span>`}
                        <div class="event-time">${formatDate(doc.created_at)}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Company documents load failed:', error);
                container.textContent = 'Kunde inte ladda dokument.';
            }
        }

        // =========================================================================
        // COMBINE & GROUP EVENTS
        // =========================================================================
        function combineAndRenderEvents() {
            // Kombinera alla events
            allEvents = [...poitEvents, ...newsItems].sort((a, b) => b.timestamp - a.timestamp);

            // Uppdatera räknare
            updateCounts();

            // Applicera filter och rendera
            applyFilter(currentFilter);
        }

        function updateCounts() {
            const counts = {
                all: allEvents.length,
                poit: poitEvents.length,
                news: newsItems.filter(n => n.type === 'news').length,
                press: newsItems.filter(n => n.type === 'press').length
            };

            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-poit').textContent = counts.poit;
            document.getElementById('count-news').textContent = counts.news;
            document.getElementById('count-press').textContent = counts.press;
        }

        function applyFilter(filter) {
            currentFilter = filter;

            // Uppdatera aktiv chip
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });

            // Filtrera events
            if (filter === 'all') {
                filteredEvents = [...allEvents];
            } else if (filter === 'poit') {
                filteredEvents = allEvents.filter(e => e.type === 'poit');
            } else if (filter === 'news') {
                filteredEvents = allEvents.filter(e => e.type === 'news');
            } else if (filter === 'press') {
                filteredEvents = allEvents.filter(e => e.type === 'press');
            }

            renderFeed();
        }

        // =========================================================================
        // GROUPING - Konsolidera händelser per företag och dag
        // =========================================================================
        function groupEventsByCompanyAndDay(events) {
            const groups = {};

            events.forEach(e => {
                const dateKey = e.date ? e.date.split('T')[0] : 'unknown';
                const companyKey = e.orgnr || e.companyName || 'unknown';
                const groupKey = `${companyKey}_${dateKey}`;

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        key: groupKey,
                        companyName: e.companyName,
                        orgnr: e.orgnr,
                        date: dateKey,
                        latestTimestamp: e.timestamp,
                        events: [],
                        logoUrl: e.logoUrl || null
                    };
                }

                groups[groupKey].events.push(e);
                if (e.timestamp > groups[groupKey].latestTimestamp) {
                    groups[groupKey].latestTimestamp = e.timestamp;
                }

                if (!groups[groupKey].logoUrl && e.logoUrl) {
                    groups[groupKey].logoUrl = e.logoUrl;
                }
            });

            // Sortera grupper efter senaste händelse
            return Object.values(groups)
                .map(group => {
                    if (!group.logoUrl && group.orgnr) {
                        group.logoUrl = getCompanyLogoUrl(group.orgnr);
                    }
                    return group;
                })
                .sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        }

        // =========================================================================
        // RENDERING
        // =========================================================================
        function renderFeed() {
            const container = document.getElementById('feed-container');

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <h3>Inga händelser</h3>
                        <p>Nya händelser visas här i realtid</p>
                    </div>
                `;
                return;
            }

            // Gruppera events
            const groups = groupEventsByCompanyAndDay(filteredEvents);

            container.innerHTML = groups.map(group => {
                if (group.events.length === 1) {
                    // Enskild händelse
                    return renderSingleEvent(group.events[0]);
                } else {
                    // Grupperad vy
                    return renderGroupedCard(group);
                }
            }).join('');
        }

        function renderSingleEvent(e) {
            const typeClass = getTypeClass(e);
            const logoUrl = e.logoUrl || getCompanyLogoUrl(e.orgnr);
            const logoMarkup = renderLogoElement(logoUrl, e.companyName);

            return `
                <div class="single-event-card" onclick="showEventModal('${e.id}')">
                    ${logoMarkup}
                    <div class="event-content">
                        <div class="company-name">${escapeHtml(e.companyName)}</div>
                        <div class="event-title">
                            ${e.link ? `<a href="${e.link}" target="_blank" class="event-link" onclick="event.stopPropagation()">${escapeHtml(e.title || '')}</a>` : escapeHtml(e.title || '')}
                        </div>
                        <div class="event-meta">
                            <span class="event-tag ${typeClass}">${escapeHtml(e.category)}</span>
                            <span>${formatDate(e.date)}</span>
                            <span class="event-time">${formatTime(e.date)}</span>
                            <span>• ${e.source}</span>
                        </div>
                    </div>
                    ${e.link ? `<a href="${e.link}" target="_blank" class="event-link" onclick="event.stopPropagation()">Läs ↗</a>` : ''}
                </div>
            `;
        }

        function renderGroupedCard(group) {
            const logoUrl = group.logoUrl || getCompanyLogoUrl(group.orgnr);
            const logoMarkup = renderLogoElement(logoUrl, group.companyName);
            const eventCount = group.events.length;

            return `
                <div class="company-card">
                    <div class="company-header" onclick='showCompanyModal("${group.orgnr || ''}", ${JSON.stringify(group.companyName || '')})'>
                        ${logoMarkup}
                        <div class="company-info">
                            <div class="company-name">${escapeHtml(group.companyName)}</div>
                            <div class="company-meta">
                                ${group.orgnr ? `<span class="company-orgnr">${group.orgnr}</span>` : ''}
                            </div>
                        </div>
                        <span class="company-time">${formatDate(group.date)}</span>
                        <span class="event-count-badge">${eventCount} händelser</span>
                    </div>
                    <div class="event-list">
                        ${group.events.map(e => renderEventItem(e)).join('')}
                    </div>
                </div>
            `;
        }

        function renderEventItem(e) {
            const typeClass = getTypeClass(e);

            return `
                <div class="event-item" onclick="showEventModal('${e.id}')">
                    <div class="event-type-indicator ${typeClass}"></div>
                    <div class="event-content">
                        <div class="event-title">
                            ${e.link ? `<a href="${e.link}" target="_blank" class="event-link" onclick="event.stopPropagation()">${escapeHtml(truncate(e.title || '', 100))}</a>` : escapeHtml(truncate(e.title || '', 100))}
                        </div>
                        <div class="event-meta">
                            <span class="event-tag ${typeClass}">${escapeHtml(e.category)}</span>
                            <span class="event-time">${formatTime(e.date)}</span>
                            <span>• ${e.source}</span>
                        </div>
                    </div>
                    ${e.link ? `<a href="${e.link}" target="_blank" class="event-link" onclick="event.stopPropagation()">↗</a>` : ''}
                </div>
            `;
        }

        function getTypeClass(e) {
            if (e.type === 'news') return 'news';
            if (e.type === 'press') return 'press';

            const cat = (e.category || '').toLowerCase();
            if (cat.includes('konkurs')) return 'konkurs';
            if (cat.includes('kallelse')) return 'kallelse';
            if (cat.includes('likvidation')) return 'likvidation';
            if (cat.includes('skuld')) return 'skuld';
            if (cat.includes('styrelse')) return 'styrelse';
            if (cat.includes('fusion')) return 'fusion';
            return 'default';
        }

        // =========================================================================
        // MODAL
        // =========================================================================
        function showEventModal(eventId) {
            const event = allEvents.find(e => e.id === eventId);
            if (!event) return;

            document.getElementById('modal-title').textContent = event.companyName;

            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <div class="detail-section-title">Händelse</div>
                    <p style="margin-bottom: 1rem;">${escapeHtml(event.title || event.content || '')}</p>
                    <div class="detail-row">
                        <span class="detail-label">Typ</span>
                        <span class="detail-value"><span class="event-tag ${getTypeClass(event)}">${escapeHtml(event.category)}</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Datum</span>
                        <span class="detail-value">${formatDate(event.date)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Källa</span>
                        <span class="detail-value">${escapeHtml(event.source)}</span>
                    </div>
                    ${event.orgnr ? `
                    <div class="detail-row">
                        <span class="detail-label">Org.nr</span>
                        <span class="detail-value">${event.orgnr}</span>
                    </div>
                    ` : ''}
                </div>
                ${event.link ? `
                <div class="detail-section">
                    <a href="${event.link}" target="_blank" class="btn btn-primary" style="width: 100%;">
                        Öppna källa ↗
                    </a>
                </div>
                ` : ''}
            `;

            document.getElementById('modal-overlay').classList.add('show');
        }

        function showCompanyModal(orgnr, companyName) {
            const company = orgnr ? companyData[orgnr] : null;
            const cleanOrgnr = cleanOrgNr(orgnr);
            const companyRecord = company || (cleanOrgnr ? companyData[cleanOrgnr] : null);
            const companyEvents = allEvents.filter(e => e.orgnr === orgnr || e.companyName === companyName);

            document.getElementById('modal-title').textContent = companyName;

            const modalLogoUrl = companyRecord?.logoUrl || getCompanyLogoUrl(orgnr);
            document.getElementById('modal-body').innerHTML = `
                <div class="company-header">
                    ${renderLogoElement(modalLogoUrl, companyName)}
                    <div class="company-info">
                        <div class="company-name">${escapeHtml(companyName)}</div>
                        ${orgnr ? `<div class="company-orgnr">${orgnr}</div>` : ''}
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">Företagsinformation</div>
                    ${companyRecord?.sector ? `
                    <div class="detail-row">
                        <span class="detail-label">Sektor</span>
                        <span class="detail-value">${escapeHtml(companyRecord.sector)}</span>
                    </div>
                    ` : ''}
                    ${companyRecord?.turnover ? `
                    <div class="detail-row">
                        <span class="detail-label">Omsättning</span>
                        <span class="detail-value">${formatNumber(companyRecord.turnover)} kr</span>
                    </div>
                    ` : ''}
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">Händelser (${companyEvents.length})</div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${companyEvents.map(e => `
                            <div class="event-item" style="padding: 0.5rem 0;">
                                <div class="event-type-indicator ${getTypeClass(e)}"></div>
                                <div class="event-content">
                                    <div class="event-title">${escapeHtml(truncate(e.title || '', 80))}</div>
                                    <div class="event-meta">
                                        <span class="event-tag ${getTypeClass(e)}">${escapeHtml(e.category)}</span>
                                        <span>${formatDate(e.date)}</span>
                                        <span class="event-time">${formatTime(e.date)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">Dokument</div>
                    <div id="company-documents-inline" class="event-meta">Laddar dokument...</div>
                </div>
            `;

            document.getElementById('modal-footer').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Stäng</button>
                ${orgnr ? `<button class="btn btn-primary" onclick="refreshCompanyData('${orgnr}', this)">Uppdatera data</button>` : ''}
            `;

            document.getElementById('modal-overlay').classList.add('show');
            if (orgnr) {
                loadCompanyDocumentsInline(orgnr);
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
        }

        async function refreshCompanyData(orgnr, button) {
            if (button) {
                button.disabled = true;
                button.textContent = 'Uppdaterar...';
            }

            try {
                const cleanOrgnr = (orgnr || '').replace(/-/g, '');
                const response = await fetch(`${CONFIG.supabase.url}/functions/v1/allabolag-proxy`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.supabase.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orgnr: cleanOrgnr, save: true })
                });

                if (!response.ok) {
                    throw new Error('Kunde inte uppdatera data');
                }

                await loadCompanyData();
                if (companyData[cleanOrgnr]?.name) {
                    showCompanyModal(cleanOrgnr, companyData[cleanOrgnr].name);
                }
            } catch (error) {
                console.error('Company refresh failed:', error);
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Uppdatera data';
                }
            }
        }

        // =========================================================================
        // UTILITIES
        // =========================================================================
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const now = new Date();

            if (date.toDateString() === now.toDateString()) return 'Idag';

            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) return 'Igår';

            return date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
        }

        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        }

        function formatNumber(num) {
            if (!num) return '-';
            return new Intl.NumberFormat('sv-SE').format(num);
        }

        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // =========================================================================
        // EVENT LISTENERS
        // =========================================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            document.getElementById('login-form-element').addEventListener('submit', handleLogin);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => applyFilter(chip.dataset.filter));
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', loadAllEvents);

            // Tabs
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Company filters
            const companySearchInput = document.getElementById('company-search-input');
            if (companySearchInput) {
                companySearchInput.addEventListener('input', (e) => {
                    companySearchQuery = e.target.value || '';
                    applyCompanyFilters();
                });
            }

            const companySectorSelect = document.getElementById('company-sector-filter');
            if (companySectorSelect) {
                companySectorSelect.addEventListener('change', (e) => {
                    companySectorFilter = e.target.value || '';
                    applyCompanyFilters();
                });
            }

            // Settings drawer
            document.getElementById('settings-open').addEventListener('click', openSettingsDrawer);
            document.getElementById('settings-close').addEventListener('click', closeSettingsDrawer);
            document.getElementById('settings-overlay').addEventListener('click', closeSettingsDrawer);
            document.getElementById('save-budget-btn').addEventListener('click', saveBudgetSettings);
            document.getElementById('save-sms-btn').addEventListener('click', saveSmsSettings);

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeSettingsDrawer();
                }
            });

            // Modal close
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal-overlay')) closeModal();
            });

            // Initialize Supabase
            initSupabase();

            // Auto-refresh every minute
            setInterval(loadAllEvents, 60 * 1000);
        });
    </script>
</body>
</html>
