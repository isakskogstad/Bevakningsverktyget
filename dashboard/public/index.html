<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyhetsredaktion - Bevakningsverktyg</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        accent: '#CCFF00',
                        'accent-dark': '#a8d900'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .collapsed .collapse-content { display: none; }
        .collapsed .collapse-icon { transform: rotate(-90deg); }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
        .log-entry { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-accent rounded flex items-center justify-center">
                    <span class="text-black font-bold text-sm">N</span>
                </div>
                <span class="text-lg font-semibold tracking-tight">Nyhetsredaktion</span>
            </div>
            <div class="text-sm text-gray-400">
                <span id="companyCount">-</span> företag
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8">

        <!-- ========================================== -->
        <!-- HUVUDSEKTION: Sök Nyheter -->
        <!-- ========================================== -->
        <section class="bg-white rounded-2xl border border-gray-200 shadow-sm mb-8">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-xl font-semibold flex items-center gap-3">
                    <span class="w-10 h-10 bg-accent rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </span>
                    Sök Nyheter
                </h1>
                <p class="text-gray-500 mt-1 ml-13">Välj ett företag och sök efter bolagshändelser för att generera nyhetsartikel</p>
            </div>

            <div class="p-6">
                <!-- Steg 1: Välj företag -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Välj företag</label>
                    <div class="relative">
                        <input type="text" id="companySearch"
                               placeholder="Sök på företagsnamn eller organisationsnummer..."
                               class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-accent focus:border-accent focus:bg-white transition-all">
                        <div id="searchResults" class="absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-64 overflow-y-auto hidden z-20"></div>
                    </div>
                </div>

                <!-- Valt företag -->
                <div id="selectedCompanyCard" class="hidden mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <div class="flex items-center gap-4">
                        <img id="selectedLogo" src="" alt="" class="w-12 h-12 rounded-lg bg-white object-contain border border-gray-100">
                        <div class="flex-1">
                            <h3 id="selectedName" class="font-semibold text-lg"></h3>
                            <p class="text-sm text-gray-500">
                                <span id="selectedOrgnr"></span>
                                <span class="mx-2">·</span>
                                <span id="selectedCity"></span>
                                <span id="selectedSectorWrapper" class="hidden">
                                    <span class="mx-2">·</span>
                                    <span id="selectedSector" class="text-accent-dark font-medium"></span>
                                </span>
                            </p>
                        </div>
                        <button onclick="clearCompany()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Steg 2: Sök-knapp -->
                <div class="mb-6">
                    <button onclick="startNewsSearch()" id="searchBtn" disabled
                            class="w-full py-4 bg-black text-white rounded-xl font-semibold text-lg hover:bg-gray-800 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Sök Nyheter
                    </button>
                </div>

                <!-- Sökprocess (visas under sökning) -->
                <div id="searchProcess" class="hidden">
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <!-- Status header -->
                        <div class="bg-gray-900 text-white px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div id="statusDot" class="w-2 h-2 bg-accent rounded-full pulse-dot"></div>
                                <span id="statusText" class="text-sm font-medium">Initierar sökning...</span>
                            </div>
                            <span id="statusTime" class="text-xs text-gray-400">0:00</span>
                        </div>

                        <!-- Log output -->
                        <div id="searchLog" class="bg-gray-950 text-gray-300 p-4 h-48 overflow-y-auto font-mono text-sm space-y-1">
                        </div>
                    </div>
                </div>

                <!-- Steg 3: Välj händelser att granska (visas efter snabbsök) -->
                <div id="eventsSelection" class="hidden">
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <div class="bg-gray-100 px-4 py-3 flex items-center justify-between">
                            <div>
                                <span class="font-semibold text-gray-900">2. Välj händelser att granska</span>
                                <p class="text-sm text-gray-500 mt-0.5">Markera de händelser du vill undersöka närmare</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="selectAllEvents()" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg transition-colors">
                                    Markera alla
                                </button>
                                <button onclick="deselectAllEvents()" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg transition-colors">
                                    Avmarkera
                                </button>
                            </div>
                        </div>

                        <!-- Lista med händelser -->
                        <div id="eventsList" class="divide-y divide-gray-100 bg-white max-h-80 overflow-y-auto">
                            <!-- Fylls dynamiskt -->
                        </div>

                        <!-- Info om potentiell kostnad -->
                        <div id="costEstimate" class="px-4 py-3 bg-gray-50 border-t border-gray-200">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">
                                    <span id="selectedCount">0</span> händelser valda
                                </span>
                                <span class="text-gray-500">
                                    Uppskattad kostnad: <span id="estimatedCost" class="font-medium text-gray-900">0 SEK</span>
                                </span>
                            </div>
                        </div>

                        <!-- Granska-knapp -->
                        <div class="p-4 bg-white border-t border-gray-200">
                            <button onclick="startDeepInvestigation()" id="investigateBtn" disabled
                                    class="w-full py-3 bg-accent text-black rounded-xl font-semibold hover:bg-accent-dark disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Nyhetsgranska händelser
                            </button>
                            <p class="text-xs text-gray-400 text-center mt-2">
                                Djupgranskning kan innebära inköp av dokument från Bolagsverket
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Djupgranskningsprocess -->
                <div id="investigationProcess" class="hidden">
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <div class="bg-black text-white px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div id="investigationDot" class="w-2 h-2 bg-accent rounded-full pulse-dot"></div>
                                <span id="investigationStatus" class="text-sm font-medium">Djupgranskar händelser...</span>
                            </div>
                            <span id="investigationTime" class="text-xs text-gray-400">0:00</span>
                        </div>
                        <div id="investigationLog" class="bg-gray-950 text-gray-300 p-4 h-48 overflow-y-auto font-mono text-sm space-y-1">
                        </div>
                    </div>
                </div>

                <!-- Genererade artiklar (visas efter djupgranskning) -->
                <div id="generatedArticles" class="hidden space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Genererade artikelutkast</h3>
                        <span id="generatedCount" class="text-sm text-gray-500">0 artiklar</span>
                    </div>
                    <div id="articlesList2" class="space-y-4">
                        <!-- Fylls dynamiskt -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- Senaste Artiklar -->
        <!-- ========================================== -->
        <section class="bg-white rounded-2xl border border-gray-200 shadow-sm mb-8">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h2 class="text-lg font-semibold">Senaste Artiklar</h2>
                <span id="articleCount" class="text-sm text-gray-400">0 artiklar</span>
            </div>
            <div id="articlesList" class="divide-y divide-gray-100">
                <div class="p-8 text-center text-gray-400">
                    Inga artiklar genererade ännu
                </div>
            </div>
            <!-- Pagination -->
            <div id="pagination" class="hidden p-4 border-t border-gray-100 flex items-center justify-center gap-2">
            </div>
        </section>

        <!-- ========================================== -->
        <!-- Kollapsade sektioner -->
        <!-- ========================================== -->

        <!-- Budget (kollapsad) -->
        <section class="bg-white rounded-xl border border-gray-200 mb-4 collapsed" id="budgetSection">
            <button onclick="toggleSection('budgetSection')" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-xl">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-gray-400 collapse-icon transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                    <span class="font-medium text-gray-700">Budget</span>
                </div>
                <span class="text-sm text-gray-400"><span id="budgetSummary">0 / 500 SEK</span></span>
            </button>
            <div class="collapse-content px-4 pb-4">
                <div class="grid grid-cols-4 gap-4 pt-2">
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Spenderat</p>
                        <p class="text-xl font-semibold"><span id="currentSpending">0</span> SEK</p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Gräns</p>
                        <p class="text-xl font-semibold"><span id="monthlyLimit">500</span> SEK</p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Kvar</p>
                        <p class="text-xl font-semibold text-green-600"><span id="remaining">500</span> SEK</p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Totalt</p>
                        <p class="text-xl font-semibold text-gray-400"><span id="totalAllTime">0</span> SEK</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Inställningar (kollapsad) -->
        <section class="bg-white rounded-xl border border-gray-200 mb-4 collapsed" id="settingsSection">
            <button onclick="toggleSection('settingsSection')" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-xl">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-gray-400 collapse-icon transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                    <span class="font-medium text-gray-700">Inställningar</span>
                </div>
            </button>
            <div class="collapse-content px-4 pb-4">
                <div class="grid grid-cols-3 gap-4 pt-2">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Månadsgräns (SEK)</label>
                        <input type="number" id="settingsLimit" value="500" class="w-full px-3 py-2 bg-gray-50 border-0 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Varningsnivå (%)</label>
                        <input type="number" id="settingsThreshold" value="80" class="w-full px-3 py-2 bg-gray-50 border-0 rounded-lg text-sm">
                    </div>
                    <div class="flex items-end">
                        <button onclick="saveSettings()" class="w-full px-4 py-2 bg-black text-white rounded-lg text-sm hover:bg-gray-800">Spara</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Köpta dokument (kollapsad) -->
        <section class="bg-white rounded-xl border border-gray-200 collapsed" id="documentsSection">
            <button onclick="toggleSection('documentsSection')" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-xl">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-gray-400 collapse-icon transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                    <span class="font-medium text-gray-700">Köpta Dokument</span>
                </div>
                <span id="documentCount" class="text-sm text-gray-400">0 dokument</span>
            </button>
            <div class="collapse-content px-4 pb-4">
                <div id="documentsList" class="pt-2 space-y-2">
                    <p class="text-sm text-gray-400 text-center py-4">Inga dokument köpta ännu</p>
                </div>
            </div>
        </section>

    </main>

    <script>
        // ==========================================
        // State
        // ==========================================
        let selectedCompany = null;
        let searchInProgress = false;
        let searchStartTime = null;
        let searchTimer = null;
        let currentArticle = null;
        let articlesPage = 1;
        const articlesPerPage = 10;

        // Nytt: händelser och granskning
        let discoveredEvents = [];
        let selectedEvents = [];
        let companyData = null;
        let investigationTimer = null;
        let investigationStartTime = null;
        let generatedArticles = [];

        // ==========================================
        // Initialize
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadBudgetStats();
            loadArticles();
            loadDocuments();
            loadCompanyCount();
            setupSearch();
        });

        // ==========================================
        // Company Search
        // ==========================================
        function setupSearch() {
            const input = document.getElementById('companySearch');
            const results = document.getElementById('searchResults');
            let debounceTimer;

            input.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => searchCompanies(e.target.value), 250);
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#companySearch') && !e.target.closest('#searchResults')) {
                    results.classList.add('hidden');
                }
            });
        }

        async function searchCompanies(query) {
            const results = document.getElementById('searchResults');
            if (query.length < 1) {
                results.classList.add('hidden');
                return;
            }

            try {
                const res = await fetch(`/api/companies/search?q=${encodeURIComponent(query)}&limit=15`);
                const companies = await res.json();

                if (companies.length === 0) {
                    results.innerHTML = '<div class="p-4 text-gray-400 text-center text-sm">Inga företag hittades</div>';
                } else {
                    results.innerHTML = companies.map(c => `
                        <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                             onclick='selectCompany(${JSON.stringify(c).replace(/'/g, "&#39;")})'>
                            <div class="font-medium text-sm">${c.company_name}</div>
                            <div class="text-xs text-gray-400 mt-0.5">
                                ${c.orgnrFormatted}${c.city ? ` · ${c.city}` : ''}${c.sector ? ` · <span class="text-accent-dark">${c.sector}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                results.classList.remove('hidden');
            } catch (e) {
                console.error('Search error:', e);
            }
        }

        function selectCompany(company) {
            selectedCompany = company;
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('companySearch').value = '';

            // Show selected card
            document.getElementById('selectedCompanyCard').classList.remove('hidden');
            document.getElementById('selectedName').textContent = company.company_name;
            document.getElementById('selectedOrgnr').textContent = company.orgnrFormatted;
            document.getElementById('selectedCity').textContent = company.city || '';

            if (company.sector) {
                document.getElementById('selectedSector').textContent = company.sector;
                document.getElementById('selectedSectorWrapper').classList.remove('hidden');
            } else {
                document.getElementById('selectedSectorWrapper').classList.add('hidden');
            }

            // Logo
            const logoUrl = `https://wzkohritxdrstsmwopco.supabase.co/storage/v1/object/public/company-logos/${company.orgnr}.png`;
            const logoImg = document.getElementById('selectedLogo');
            logoImg.src = logoUrl;
            logoImg.onerror = () => {
                logoImg.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><rect fill="%23CCFF00" width="48" height="48" rx="8"/><text x="24" y="32" text-anchor="middle" fill="%23000" font-family="Inter,sans-serif" font-size="22" font-weight="600">${(company.company_name?.[0] || '?')}</text></svg>`;
            };

            document.getElementById('searchBtn').disabled = false;
        }

        function clearCompany() {
            selectedCompany = null;
            document.getElementById('selectedCompanyCard').classList.add('hidden');
            document.getElementById('searchBtn').disabled = true;
        }

        // ==========================================
        // News Search Process (Steg 1: Hitta händelser)
        // ==========================================
        async function startNewsSearch() {
            if (!selectedCompany || searchInProgress) return;

            searchInProgress = true;
            searchStartTime = Date.now();
            discoveredEvents = [];
            selectedEvents = [];
            companyData = null;
            generatedArticles = [];

            const btn = document.getElementById('searchBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Söker...';

            // Show search process, hide other sections
            document.getElementById('searchProcess').classList.remove('hidden');
            document.getElementById('eventsSelection').classList.add('hidden');
            document.getElementById('investigationProcess').classList.add('hidden');
            document.getElementById('generatedArticles').classList.add('hidden');
            document.getElementById('searchLog').innerHTML = '';

            // Start timer
            searchTimer = setInterval(updateSearchTime, 1000);

            // Log entries
            addLog('info', `Startar nyhetssökning för ${selectedCompany.company_name}`);
            addLog('info', `Organisationsnummer: ${selectedCompany.orgnr}`);

            try {
                // Call backend to start search
                const response = await fetch('/api/news/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orgnr: selectedCompany.orgnr,
                        companyName: selectedCompany.company_name
                    })
                });

                // Stream the response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    const lines = text.split('\n').filter(l => l.startsWith('data: '));

                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            handleSearchEvent(data);
                        } catch (e) {}
                    }
                }

            } catch (error) {
                addLog('error', `Fel: ${error.message}`);
                updateStatus('Sökningen misslyckades', false);
            }

            // Cleanup
            clearInterval(searchTimer);
            searchInProgress = false;
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Sök Nyheter';
        }

        function handleSearchEvent(data) {
            switch (data.type) {
                case 'log':
                    addLog(data.level || 'info', data.message);
                    break;
                case 'status':
                    updateStatus(data.message, data.active);
                    break;
                case 'events':
                    // Nya händelser hittades
                    discoveredEvents = data.events || [];
                    companyData = data.companyData || null;
                    break;
                case 'complete':
                    updateStatus('Sökning klar!', false);
                    addLog('success', 'Nyhetssökning slutförd');
                    // Visa händelseval om vi hittade något
                    if (discoveredEvents.length > 0) {
                        showEventsSelection();
                    } else {
                        addLog('warning', 'Inga bolagshändelser hittades för detta företag');
                    }
                    break;
                case 'error':
                    addLog('error', data.message);
                    break;
            }
        }

        // ==========================================
        // Events Selection (Steg 2: Välj händelser)
        // ==========================================
        function showEventsSelection() {
            const container = document.getElementById('eventsSelection');
            const list = document.getElementById('eventsList');

            // Kostnadsestimat per händelsetyp (SEK)
            const costByType = {
                'Årsredovisning': 40,
                'Styrelseändring': 20,
                'Adressändring': 0,
                'Kapitalförändring': 20,
                'Firmaändring': 20,
                'Bolagsstämmoprotokoll': 50,
                'Ändring av ändamål': 20,
                'default': 20
            };

            list.innerHTML = discoveredEvents.map((event, index) => {
                const cost = costByType[event.type] || costByType.default;
                return `
                    <label class="flex items-start gap-4 p-4 hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="checkbox"
                               class="event-checkbox mt-1 w-5 h-5 rounded border-gray-300 text-accent focus:ring-accent"
                               data-index="${index}"
                               data-cost="${cost}"
                               onchange="updateSelectedEvents()">
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-900">${event.type}</span>
                                <span class="text-sm text-gray-400">${event.date}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-0.5">${event.description}</p>
                            ${cost > 0 ? `<p class="text-xs text-amber-600 mt-1">Kan kräva dokumentinköp (~${cost} SEK)</p>` : '<p class="text-xs text-green-600 mt-1">Gratis att granska</p>'}
                        </div>
                    </label>
                `;
            }).join('');

            container.classList.remove('hidden');
            updateSelectedEvents();
        }

        function updateSelectedEvents() {
            const checkboxes = document.querySelectorAll('.event-checkbox');
            selectedEvents = [];
            let totalCost = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const idx = parseInt(cb.dataset.index);
                    selectedEvents.push(discoveredEvents[idx]);
                    totalCost += parseInt(cb.dataset.cost) || 0;
                }
            });

            document.getElementById('selectedCount').textContent = selectedEvents.length;
            document.getElementById('estimatedCost').textContent = `${totalCost} SEK`;
            document.getElementById('investigateBtn').disabled = selectedEvents.length === 0;
        }

        function selectAllEvents() {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = true);
            updateSelectedEvents();
        }

        function deselectAllEvents() {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = false);
            updateSelectedEvents();
        }

        // ==========================================
        // Deep Investigation (Steg 3: Djupgranskning)
        // ==========================================
        async function startDeepInvestigation() {
            if (selectedEvents.length === 0) return;

            investigationStartTime = Date.now();

            // Visa granskningsprocess
            document.getElementById('eventsSelection').classList.add('hidden');
            document.getElementById('investigationProcess').classList.remove('hidden');
            document.getElementById('investigationLog').innerHTML = '';
            generatedArticles = [];

            // Start timer
            investigationTimer = setInterval(updateInvestigationTime, 1000);

            addInvestigationLog('info', `Startar djupgranskning av ${selectedEvents.length} händelse(r)...`);

            try {
                const response = await fetch('/api/news/investigate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orgnr: selectedCompany.orgnr,
                        companyName: selectedCompany.company_name,
                        events: selectedEvents,
                        companyData: companyData
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    const lines = text.split('\n').filter(l => l.startsWith('data: '));

                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            handleInvestigationEvent(data);
                        } catch (e) {}
                    }
                }

            } catch (error) {
                addInvestigationLog('error', `Fel: ${error.message}`);
            }

            clearInterval(investigationTimer);
        }

        function handleInvestigationEvent(data) {
            switch (data.type) {
                case 'log':
                    addInvestigationLog(data.level || 'info', data.message);
                    break;
                case 'progress':
                    // Uppdatera progress indicator (kan användas för progress bar)
                    break;
                case 'purchase':
                    // Registrera potentiellt dokumentköp
                    addInvestigationLog('info', `Dokumentköp: ${data.eventType} (${data.cost} SEK)`);
                    break;
                case 'articles':
                    // Alla artiklar skickas tillsammans
                    generatedArticles = data.articles || [];
                    break;
                case 'complete':
                    updateInvestigationStatus('Djupgranskning klar!');
                    showGeneratedArticles();
                    break;
                case 'error':
                    addInvestigationLog('error', data.message);
                    break;
            }
        }

        function addInvestigationLog(level, message) {
            const log = document.getElementById('investigationLog');
            const time = new Date().toLocaleTimeString('sv-SE');
            const colors = {
                info: 'text-gray-400',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400'
            };

            const entry = document.createElement('div');
            entry.className = `log-entry ${colors[level] || 'text-gray-400'}`;
            entry.innerHTML = `<span class="text-gray-600">[${time}]</span> ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateInvestigationStatus(message) {
            document.getElementById('investigationStatus').textContent = message;
            const dot = document.getElementById('investigationDot');
            dot.classList.remove('pulse-dot');
            dot.classList.add('bg-green-400');
            dot.classList.remove('bg-accent');
        }

        function updateInvestigationTime() {
            const elapsed = Math.floor((Date.now() - investigationStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('investigationTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ==========================================
        // Generated Articles Display
        // ==========================================
        function showGeneratedArticles() {
            const container = document.getElementById('generatedArticles');
            const list = document.getElementById('articlesList2');

            document.getElementById('generatedCount').textContent = `${generatedArticles.length} artiklar`;

            list.innerHTML = generatedArticles.map((article, index) => `
                <div class="border border-gray-200 rounded-xl overflow-hidden">
                    <div class="bg-accent px-4 py-3 flex items-center justify-between">
                        <span class="font-semibold text-black">Artikel ${index + 1}: ${article.eventType || 'Bolagshändelse'}</span>
                        <div class="flex gap-2">
                            <button onclick="copyArticleByIndex(${index})" class="px-3 py-1 bg-black/10 hover:bg-black/20 rounded-lg text-sm font-medium transition-colors">
                                Kopiera
                            </button>
                            <button onclick="saveArticleByIndex(${index})" class="px-3 py-1 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors">
                                Spara
                            </button>
                        </div>
                    </div>
                    <div class="p-6 bg-white">
                        <h2 class="text-xl font-bold mb-3">${article.headline}</h2>
                        <p class="text-gray-600 mb-4 leading-relaxed">${article.lead || ''}</p>
                        <div class="text-gray-700 leading-relaxed whitespace-pre-line text-sm">${article.body || ''}</div>
                    </div>
                </div>
            `).join('');

            container.classList.remove('hidden');
        }

        function copyArticleByIndex(index) {
            const article = generatedArticles[index];
            if (!article) return;
            const text = `${article.headline}\n\n${article.lead || ''}\n\n${article.body || ''}`;
            navigator.clipboard.writeText(text);
            alert('Artikel kopierad!');
        }

        async function saveArticleByIndex(index) {
            const article = generatedArticles[index];
            if (!article || !selectedCompany) return;

            try {
                const res = await fetch('/api/news/articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...article,
                        orgnr: selectedCompany.orgnr,
                        companyName: selectedCompany.company_name
                    })
                });

                if (res.ok) {
                    alert('Artikel sparad!');
                    loadArticles();
                }
            } catch (e) {
                alert('Kunde inte spara artikel');
            }
        }

        function addLog(level, message) {
            const log = document.getElementById('searchLog');
            const time = new Date().toLocaleTimeString('sv-SE');
            const colors = {
                info: 'text-gray-400',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                highlight: 'text-accent'
            };

            const entry = document.createElement('div');
            entry.className = `log-entry ${colors[level] || 'text-gray-400'}`;
            entry.innerHTML = `<span class="text-gray-600">[${time}]</span> ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(message, active = true) {
            document.getElementById('statusText').textContent = message;
            const dot = document.getElementById('statusDot');
            if (active) {
                dot.classList.add('pulse-dot', 'bg-accent');
                dot.classList.remove('bg-green-400', 'bg-red-400');
            } else {
                dot.classList.remove('pulse-dot');
                if (message.includes('klar') || message.includes('slutförd')) {
                    dot.classList.add('bg-green-400');
                    dot.classList.remove('bg-accent');
                }
            }
        }

        function updateSearchTime() {
            const elapsed = Math.floor((Date.now() - searchStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('statusTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ==========================================
        // Articles List
        // ==========================================
        async function loadArticles(page = 1) {
            articlesPage = page;
            try {
                const res = await fetch(`/api/news/articles?limit=${articlesPerPage}&offset=${(page - 1) * articlesPerPage}`);
                const { articles, total } = await res.json();

                document.getElementById('articleCount').textContent = `${total} artiklar`;

                const list = document.getElementById('articlesList');
                if (!articles || articles.length === 0) {
                    list.innerHTML = '<div class="p-8 text-center text-gray-400">Inga artiklar genererade ännu</div>';
                    document.getElementById('pagination').classList.add('hidden');
                    return;
                }

                list.innerHTML = articles.map(a => `
                    <div class="p-4 hover:bg-gray-50 transition-colors cursor-pointer" onclick="viewArticle('${a.id}')">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-900 truncate">${a.headline}</h3>
                                <p class="text-sm text-gray-500 mt-1 line-clamp-2">${a.lead || ''}</p>
                                <div class="flex items-center gap-3 mt-2 text-xs text-gray-400">
                                    <span>${a.company_name || 'Okänt företag'}</span>
                                    <span>·</span>
                                    <span>${new Date(a.created_at).toLocaleDateString('sv-SE')}</span>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full ${a.status === 'published' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                                ${a.status === 'published' ? 'Publicerad' : 'Utkast'}
                            </span>
                        </div>
                    </div>
                `).join('');

                // Pagination
                const totalPages = Math.ceil(total / articlesPerPage);
                if (totalPages > 1) {
                    document.getElementById('pagination').classList.remove('hidden');
                    document.getElementById('pagination').innerHTML = Array.from({length: totalPages}, (_, i) => `
                        <button onclick="loadArticles(${i + 1})"
                                class="w-8 h-8 rounded ${i + 1 === page ? 'bg-black text-white' : 'bg-gray-100 hover:bg-gray-200'} text-sm font-medium">
                            ${i + 1}
                        </button>
                    `).join('');
                } else {
                    document.getElementById('pagination').classList.add('hidden');
                }

            } catch (e) {
                console.error('Error loading articles:', e);
            }
        }

        function viewArticle(id) {
            // Could open modal or navigate
            window.open(`/api/news/articles/${id}`, '_blank');
        }

        // ==========================================
        // Collapsible Sections
        // ==========================================
        function toggleSection(sectionId) {
            document.getElementById(sectionId).classList.toggle('collapsed');
        }

        // ==========================================
        // Budget & Settings
        // ==========================================
        async function loadBudgetStats() {
            try {
                const res = await fetch('/api/budget/stats');
                const stats = await res.json();

                document.getElementById('currentSpending').textContent = stats.currentMonthSpending.toFixed(0);
                document.getElementById('monthlyLimit').textContent = stats.monthlyLimit;
                document.getElementById('remaining').textContent = stats.remaining.toFixed(0);
                document.getElementById('totalAllTime').textContent = stats.totalAllTime.toFixed(0);
                document.getElementById('budgetSummary').textContent = `${stats.currentMonthSpending.toFixed(0)} / ${stats.monthlyLimit} SEK`;

                if (stats.settings) {
                    document.getElementById('settingsLimit').value = stats.settings.monthly_limit_sek;
                    document.getElementById('settingsThreshold').value = Math.round(stats.settings.alert_threshold * 100);
                }
            } catch (e) {}
        }

        async function loadDocuments() {
            try {
                const res = await fetch('/api/documents?limit=10');
                const { documents, total } = await res.json();
                document.getElementById('documentCount').textContent = `${total} dokument`;

                const list = document.getElementById('documentsList');
                if (!documents || documents.length === 0) {
                    list.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Inga dokument köpta ännu</p>';
                    return;
                }

                list.innerHTML = documents.map(d => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm">
                        <div>
                            <span class="font-medium">${d.company_name || d.orgnr}</span>
                            <span class="text-gray-400 ml-2">${d.document_type}</span>
                        </div>
                        <span class="text-gray-400">${d.amount_sek} SEK</span>
                    </div>
                `).join('');
            } catch (e) {}
        }

        async function loadCompanyCount() {
            try {
                const res = await fetch('/api/companies/stats');
                const stats = await res.json();
                document.getElementById('companyCount').textContent = stats.totalCompanies;
            } catch (e) {}
        }

        async function saveSettings() {
            // Implementation for saving settings
            alert('Inställningar sparade');
        }
    </script>
</body>
</html>
